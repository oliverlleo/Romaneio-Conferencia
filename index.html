<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor de Planilha com Regras | Flat Design</title>

    <!-- SDKs do Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <!-- Biblioteca SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Fontes e Ícones -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        :root {
            --font-family-sans: 'Montserrat', sans-serif; --color-text: #1E293B; --color-text-light: #64748B; --color-bg: #F1F5F9; --color-panel-bg: #FFFFFF; --color-border: #E2E8F0; --color-accent-primary: #0D9488; --color-accent-primary-hover: #0F766E; --color-accent-secondary: #475569; --color-accent-secondary-hover: #334155; --color-success: #16A34A; --color-success-hover: #15803D; --color-danger: #DC2626; --color-danger-hover: #B91C1C; --color-warning: #D97706; --color-warning-hover: #B45309;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; }
        body { font-family: var(--font-family-sans); background-color: var(--color-bg); color: var(--color-text); line-height: 1.5; -webkit-font-smoothing: antialiased; }
        .app-container { display: block; width: 100%; max-width: 1200px; margin: 2rem auto; padding: 2rem; background-color: var(--color-panel-bg); border-radius: 8px; }
        .app-header { font-size: 2rem; font-weight: 700; text-align: center; margin-bottom: 2rem; color: var(--color-text); }
        .action-bar { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; }
        .status-text { text-align: center; margin: 2rem 0; color: var(--color-text-light); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1.5rem; border: none; border-radius: 6px; font-family: var(--font-family-sans); font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s ease; text-decoration: none; flex-grow: 1; }
        .btn i { width: 18px; height: 18px; }
        .btn--primary { background-color: var(--color-accent-primary); color: white; }
        .btn--primary:hover { background-color: var(--color-accent-primary-hover); }
        .btn--secondary { background-color: var(--color-accent-secondary); color: white; }
        .btn--secondary:hover { background-color: var(--color-accent-secondary-hover); }
        .btn--success { background-color: var(--color-success); color: white; }
        .btn--success:hover { background-color: var(--color-success-hover); }
        .btn--warning { background-color: var(--color-warning); color: white; }
        .btn--warning:hover { background-color: var(--color-warning-hover); }
        .btn--danger { background-color: var(--color-danger); color: white; }
        .btn--danger:hover { background-color: var(--color-danger-hover); }
        .btn--text { background-color: transparent; color: var(--color-accent-primary); padding: 0.25rem; justify-content: flex-start; flex-grow: 0; border-radius: 4px; }
        .btn--text:hover { color: var(--color-accent-primary-hover); background-color: var(--color-bg); }
        .btn--icon { background: transparent; border: 1px solid var(--color-border); color: var(--color-text-light); padding: 0.75rem; cursor: pointer; line-height: 1; flex-grow: 0; border-radius: 6px; }
        .btn--icon:hover { color: var(--color-accent-primary); border-color: var(--color-accent-primary); background-color: #F0FDFA; }
        .btn--icon.btn--warning:hover { color: var(--color-warning); border-color: var(--color-warning); background-color: #FFFBEB; }
        .file-input { display: none; }
        .view { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--color-bg); z-index: 2000; padding: 2rem; overflow-y: auto; }
        .view__title { font-size: 2rem; font-weight: 700; margin-bottom: 2rem; color: var(--color-text); }
        .view__content { max-width: 900px; margin: 0 auto; }
        .modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(30, 41, 59, 0.8); align-items: center; justify-content: center; }
        .modal__content { background-color: var(--color-panel-bg); padding: 2.5rem; border-radius: 8px; width: 90%; max-width: 700px; position: relative; max-height: 90vh; overflow-y: auto; }
        .modal__content--large { max-width: 1100px; }
        .modal__close { color: var(--color-text-light); position: absolute; top: 1rem; right: 1.5rem; font-size: 2rem; font-weight: bold; cursor: pointer; line-height: 1; }
        .modal__close:hover { color: var(--color-text); }
        .modal__section { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--color-border); }
        .modal__subtitle { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--color-accent-secondary); }
        .form-grid { display: grid; gap: 1rem; }
        .form-input, .form-textarea, .form-select { width: 100%; padding: 0.75rem; border-radius: 6px; font-family: var(--font-family-sans); font-size: 1rem; background-color: var(--color-bg); border: 1px solid var(--color-border); color: var(--color-text); }
        .form-input:focus, .form-textarea:focus, .form-select:focus { outline: 2px solid var(--color-accent-primary); border-color: var(--color-accent-primary); }
        .checklist-item-wrapper { display: flex; align-items: center; gap: 0.5rem; }
        .drag-handle { cursor: grab; color: var(--color-text-light); }
        .checklist-item-wrapper.dragging { opacity: 0.5; background: var(--color-border); }
        .spreadsheet-header { margin-bottom: 1.5rem; }
        .spreadsheet-header__content { background-color: var(--color-bg); padding: 1.5rem; border-radius: 8px; }
        .spreadsheet-header__line { margin-bottom: 0.5rem; }
        .spreadsheet-header__line--title { font-size: 1.25rem; font-weight: 700; }
        .table-wrapper { width: 100%; overflow-x: auto; border: 1px solid var(--color-border); border-radius: 8px; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table__th, .data-table__td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--color-border); white-space: nowrap; }
        .data-table tr:last-child .data-table__td { border-bottom: none; }
        .data-table__th { background-color: var(--color-bg); font-weight: 600; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--color-text-light); }
        .rules-list { display: grid; gap: 1rem; }
        .rule-item { background-color: var(--color-bg); padding: 1rem; border-radius: 6px; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem; }
        .rule-item__info { flex-grow: 1; }
        .rule-item__actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
        .rule-item__code { font-weight: 600; }
        .rule-item__checklist { list-style-position: inside; padding-left: 0.5rem; color: var(--color-text-light); font-size: 0.9rem; }
        .analysis-result { background-color: var(--color-bg); padding: 1rem; max-height: 60vh; overflow-y: auto; border-radius: 6px; }
        .analysis-result__item { padding: 0.5rem 1rem; margin-bottom: 0.5rem; border-radius: 4px; }
        .analysis-result__item--success { background-color: #D1FAE5; color: #065F46; }
        .analysis-result__item--fail { background-color: #FEE2E2; color: #991B1B; }
        .romaneio-page { flex-grow: 1; overflow-y: auto; background-color: var(--color-panel-bg); padding: 2rem; }
        .romaneio-header { margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid var(--color-text); }
        .romaneio-header p { margin-bottom: 0.25rem; }
        .romaneio-header strong { font-size: 1.5rem; display: block; margin-bottom: 1rem; }
        .romaneio-item { padding: 1.5rem 0; display: flex; gap: 1rem; border-bottom: 1px solid var(--color-border); }
        .romaneio-item__info { flex-grow: 1; }
        .romaneio-item__pos { font-size: 0.9rem; color: var(--color-text-light); font-weight: 500; }
        .romaneio-item__code { font-size: 1.2rem; font-weight: 700; }
        .romaneio-item__desc { font-size: 1rem; color: var(--color-text-light); }
        .romaneio-item__tipo { font-size: 1.2rem; font-weight: 700; color: var(--color-danger); margin-top: 0.25rem; }
        .romaneio-item__image { max-width: 70%; height: auto; margin-top: 1rem; border-radius: 6px; }
        .romaneio-item__checklist { flex-shrink: 0; width: 40%; border-left: 1px solid var(--color-border); padding-left: 1.5rem; }
        .romaneio-item__checklist-title { font-weight: 600; margin-bottom: 1rem; }
        .romaneio-item__checklist-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem; }
        .romaneio-item__checkbox-group { display: flex; gap: 0.5rem; }
        .romaneio-item__checkbox-box { width: 20px; height: 20px; border: 2px solid var(--color-text-light); border-radius: 4px; flex-shrink: 0; }
        .romaneio-item__symbol { margin-right: 0.5rem; font-size: 1.2rem; line-height: 1; }
        .romaneio-footer { padding: 1.5rem 2rem; background-color: var(--color-bg); }
        .romaneio-observations { border-top: 1px solid var(--color-border); padding-top: 1.5rem; margin-top: 1.5rem; }
        .romaneio-signatures { padding-top: 4rem; margin-top: 4rem; display: flex; justify-content: space-around; }
        .signature-line { text-align: center; }
        .signature-line > div { border-top: 1px solid var(--color-text); width: 200px; margin-bottom: 0.5rem; }
        .conference-item { display: flex; flex-wrap: wrap; gap: 1.5rem; padding: 1.5rem; border-bottom: 1px solid var(--color-border); background-color: var(--color-panel-bg); align-items: flex-start; }
        .conference-item:nth-child(even) { background-color: var(--color-bg); }
        .conference-item__image-wrapper { flex: 0 0 20%; max-width: 20%; }
        .conference-item__info { flex: 1 1 35%; }
        .conference-item__checklist { flex: 1 1 40%; }
        .conference-item__pos { font-size: 0.9rem; color: var(--color-text-light); font-weight: 500; }
        .conference-item__code { font-size: 1.2rem; font-weight: 700; }
        .conference-item__desc { font-size: 1rem; color: var(--color-text-light); }
        .conference-item__image { max-width: 100%; height: auto; border: 1px solid var(--color-border); border-radius: 6px; }
        .interactive-checklist-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem; padding: 0.75rem; border-radius: 6px; transition: background-color 0.2s; }
        .interactive-checklist-item:hover { background-color: #F8FAFC; }
        .interactive-checklist-item label { display: flex; align-items: center; gap: 0.75rem; cursor: pointer; font-size: 1rem; }
        .interactive-checklist-item input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
        @media print { @page { size: A4; margin: 1cm; } body { background-color: #fff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; } body > *:not(#romaneioModal), .modal__close, .romaneio-footer { display: none !important; } #romaneioModal, #romaneioModal .modal__content, .romaneio-page { position: static !important; display: block !important; width: 100% !important; height: auto !important; overflow: visible !important; background: transparent !important; border: none !important; box-shadow: none !important; padding: 0 !important; margin: 0 !important; } .romaneio-item { page-break-inside: avoid; } }
    </style>
</head>
<body>

    <main class="app-container">
        <h1 class="app-header">Leitor de Planilhas com Regras</h1>
        <div class="action-bar">
            <label for="fileInput" class="btn btn--primary"><i data-feather="file-plus"></i> <span>Selecionar Planilha</span></label>
            <input type="file" id="fileInput" class="file-input" accept=".xlsx, .xls, .csv">
            <button id="configButton" class="btn btn--secondary"><i data-feather="settings"></i> <span>Configurações</span></button>
            <button id="analyzeTableButton" class="btn btn--warning"><i data-feather="bar-chart-2"></i> <span>Analisar Tabela</span></button>
            <button id="accessClientsButton" class="btn btn--primary"><i data-feather="users"></i> <span>Acessar Clientes</span></button>
            <button id="saveClientButton" class="btn btn--success" style="display: none;"><i data-feather="save"></i> <span>Salvar Cliente</span></button>
        </div>
        <p id="status" class="status-text">Nenhum arquivo selecionado.</p>
        <div id="spreadsheet-header-container" class="spreadsheet-header"></div>
        <div id="table-container" class="table-wrapper">
             <!-- A tabela da planilha carregada aparece aqui -->
        </div>
        <textarea id="observation-notes" class="form-textarea" rows="4" placeholder="Adicione observações para o relatório final aqui..." style="margin-top: 1rem;"></textarea>
    </main>

    <!-- VIEWS DE TELA CHEIA -->
    <div id="clients-view" class="view">
        <div class="view__content">
            <h2 class="view__title">Clientes em Produção</h2>
            <button class="btn btn--secondary" style="margin-bottom: 2rem; max-width: 200px;" onclick="showMainView()">
                <i data-feather="arrow-left"></i> <span>Voltar</span>
            </button>
            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="data-table__th">Nome do Cliente</th>
                            <th class="data-table__th" style="width: 520px;">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="production-clients-list"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="production-item-view" class="view">
        <!-- Conteúdo do checklist interativo será injetado aqui -->
    </div>

    <!-- MODAL DE CONFIGURAÇÕES (LÓGICA ORIGINAL RESTAURADA) -->
    <div id="configModal" class="modal">
        <div class="modal__content">
            <span class="modal__close" onclick="this.parentElement.parentElement.style.display='none'">&times;</span>
            <h2 class="modal__title">Gerenciar Regras</h2>
            <div class="action-bar" style="margin-bottom: 2rem;">
                <button id="config-mode-romaneio" class="btn btn--secondary">Regras de Romaneio</button>
                <button id="config-mode-producao" class="btn btn--secondary">Regras de Produção</button>
            </div>
            
            <div id="rule-form-section" class="modal__section">
                <h3 id="rule-form-title" class="modal__subtitle">Regras de Código</h3>
                <div class="form-grid">
                    <input type="hidden" id="ruleId">
                    <input type="text" id="ruleCode" placeholder="Se o código CONTÉM..." class="form-input">
                    <div id="newChecklistContainer"></div>
                    <button id="addChecklistItem" class="btn btn--text"><i data-feather="plus"></i> Adicionar item</button>
                    <button id="saveRule" class="btn btn--success">Salvar Regra de Código</button>
                    <button id="cancelEdit" class="btn btn--secondary" style="display: none;">Cancelar Edição</button>
                </div>
            </div>
            <div class="modal__section">
                <h3 class="modal__subtitle">Regras de Código Salvas</h3>
                <div id="rulesList" class="rules-list"></div>
            </div>
            <div id="part-rule-form-section" class="modal__section">
                <h3 id="part-rule-form-title" class="modal__subtitle">Regras de Peça</h3>
                <div class="form-grid">
                    <input type="hidden" id="partRuleId">
                    <input type="text" id="partRuleCode" placeholder="Se o código CONTÉM..." class="form-input">
                    <div id="newPartChecklistContainer"></div>
                    <button id="addPartChecklistItem" class="btn btn--text"><i data-feather="plus"></i> Adicionar item de peça</button>
                    <button id="savePartRule" class="btn btn--success">Salvar Regra de Peça</button>
                    <button id="cancelPartEdit" class="btn btn--secondary" style="display: none;">Cancelar Edição</button>
                </div>
            </div>
             <div class="modal__section">
                <h3 class="modal__subtitle">Regras de Peça Salvas</h3>
                <div id="partRulesList" class="rules-list"></div>
            </div>
        </div>
    </div>

    <!-- MODAL DE ANÁLISE -->
    <div id="analysisModal" class="modal">
        <div class="modal__content">
            <span class="modal__close" onclick="this.parentElement.parentElement.style.display='none'">&times;</span>
            <h2 class="modal__title">Resultado da Análise</h2>
            <div id="analysisResult" class="analysis-result"></div>
        </div>
    </div>

    <!-- MODAL DE ROMANEIO -->
    <div id="romaneioModal" class="modal">
        <div class="modal__content modal__content--large">
            <span class="modal__close" onclick="this.parentElement.parentElement.style.display='none'">&times;</span>
            <div id="romaneio-page" class="romaneio-page">
                <div id="romaneio-header"></div>
                <div id="romaneio-items"></div>
            </div>
            <div class="romaneio-footer">
                <button onclick="window.print()" class="btn btn--primary"><i data-feather="printer"></i><span>Imprimir</span></button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURAÇÃO FIREBASE ---
        const firebaseConfig = {"apiKey":"AIzaSyCB8ye34UIkBghExod4JlBV3oqge5oM2Ic","authDomain":"ferramentas-perfecta.firebaseapp.com","databaseURL":"https://ferramentas-perfecta-default-rtdb.firebaseio.com","projectId":"ferramentas-perfecta","storageBucket":"ferramentas-perfecta.appspot.com","messagingSenderId":"550722056346","appId":"1:550722056346:web:9e2e0948c58e15b5af6f23"};
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- VARIÁVEIS GLOBAIS ---
        let fullSpreadsheetData = [];
        let rulesRef;
        let rulesPartRef;
        let rules = [];
        let partRules = [];

        // --- CONTROLE DE NAVEGAÇÃO E MODAIS ---
        const mainContainer = document.querySelector('.app-container');
        const clientsView = document.getElementById('clients-view');
        const itemView = document.getElementById('production-item-view');
        const configModal = document.getElementById('configModal');
        const analysisModal = document.getElementById('analysisModal');

        function showMainView() {
            mainContainer.style.display = 'block';
            clientsView.style.display = 'none';
            itemView.style.display = 'none';
        }
        function showClientsView() {
            mainContainer.style.display = 'none';
            clientsView.style.display = 'block';
            itemView.style.display = 'none';
            loadClientsList();
        }
        
        function showConfigModal() {
            configModal.style.display = 'flex';
            loadConfigForms('romaneio');
        }
        
        function showAnalysisModal() {
            analysisModal.style.display = 'flex';
            analyzeCurrentTable();
        }

        document.getElementById('configButton').onclick = showConfigModal;
        document.getElementById('accessClientsButton').onclick = showClientsView;
        document.getElementById('analyzeTableButton').onclick = showAnalysisModal;
        
        // --- LÓGICA DA TELA DE CONFIGURAÇÃO (FUNCIONAL E COMPLETA) ---
        function loadConfigForms(mode) {
            const romaneioBtn = document.getElementById('config-mode-romaneio');
            const producaoBtn = document.getElementById('config-mode-producao');
            
            if (rulesRef) rulesRef.off();
            if (rulesPartRef) rulesPartRef.off();
            
            document.getElementById('rulesList').innerHTML = 'Carregando...';
            document.getElementById('partRulesList').innerHTML = 'Carregando...';

            if (mode === 'romaneio') {
                rulesRef = database.ref('dados/romaneio');
                rulesPartRef = database.ref('dados/romaneioPecas');
                romaneioBtn.style.backgroundColor = 'var(--color-accent-secondary)';
                producaoBtn.style.backgroundColor = 'var(--color-text-light)';
            } else {
                rulesRef = database.ref('dados/producao');
                rulesPartRef = database.ref('dados/producaoPecas');
                romaneioBtn.style.backgroundColor = 'var(--color-text-light)';
                producaoBtn.style.backgroundColor = 'var(--color-accent-secondary)';
            }
            attachFirebaseListeners();
        }
        document.getElementById('config-mode-romaneio').addEventListener('click', () => loadConfigForms('romaneio'));
        document.getElementById('config-mode-producao').addEventListener('click', () => loadConfigForms('producao'));

        function attachFirebaseListeners() {
            rulesRef.on('value', snapshot => {
                const data = snapshot.val();
                const listEl = document.getElementById('rulesList');
                listEl.innerHTML = '';
                rules = [];
                if (data) {
                    Object.entries(data).forEach(([key, rule]) => {
                        rules.push({ id: key, ...rule });
                        const ruleEl = document.createElement('div');
                        ruleEl.className = 'rule-item';
                        const checklistHTML = rule.checklist.map(item => `<li>${item.symbol || '■'} ${item.text}</li>`).join('');
                        ruleEl.innerHTML = `
                            <div class="rule-item__info">
                                <p class="rule-item__code">Código contém: "${rule.codigo}"</p>
                                <ul class="rule-item__checklist">${checklistHTML}</ul>
                            </div>
                            <div class="rule-item__actions">
                                <button onclick="editRule('${key}')" class="btn btn--secondary"><i data-feather="edit-2"></i></button>
                                <button onclick="deleteRule('${key}')" class="btn btn--danger"><i data-feather="trash-2"></i></button>
                            </div>`;
                        listEl.appendChild(ruleEl);
                    });
                } else {
                    listEl.innerHTML = '<p>Nenhuma regra de código cadastrada.</p>';
                }
                feather.replace();
            });
            rulesPartRef.on('value', snapshot => {
                const data = snapshot.val();
                const listEl = document.getElementById('partRulesList');
                listEl.innerHTML = '';
                partRules = [];
                if (data) {
                    Object.entries(data).forEach(([key, rule]) => {
                        partRules.push({ id: key, ...rule });
                        const ruleEl = document.createElement('div');
                        ruleEl.className = 'rule-item';
                        const checklistHTML = rule.checklist.map(item => `<li>${item.symbol || '■'} ${item.text} (x${item.quantity})</li>`).join('');
                        ruleEl.innerHTML = `
                             <div class="rule-item__info">
                                <p class="rule-item__code">Código contém: "${rule.codigo}"</p>
                                <ul class="rule-item__checklist">${checklistHTML}</ul>
                            </div>
                            <div class="rule-item__actions">
                                <button onclick="editPartRule('${key}')" class="btn btn--secondary"><i data-feather="edit-2"></i></button>
                                <button onclick="deletePartRule('${key}')" class="btn btn--danger"><i data-feather="trash-2"></i></button>
                            </div>`;
                        listEl.appendChild(ruleEl);
                    });
                } else {
                    listEl.innerHTML = '<p>Nenhuma regra de peça cadastrada.</p>';
                }
                feather.replace();
            });
        }
        
        function deleteRule(key) { if(confirm('Tem certeza?')) rulesRef.child(key).remove(); }
        function deletePartRule(key) { if(confirm('Tem certeza?')) rulesPartRef.child(key).remove(); }
        
        function editRule(key) {
            const ruleToEdit = rules.find(r => r.id === key);
            if(ruleToEdit) {
                document.getElementById('ruleId').value = ruleToEdit.id;
                document.getElementById('ruleCode').value = ruleToEdit.codigo;
                const container = document.getElementById('newChecklistContainer');
                container.innerHTML = '';
                ruleToEdit.checklist.forEach(item => addChecklistItemInput(container.id, item));
                document.getElementById('cancelEdit').style.display = 'inline-flex';
            }
        }
        function editPartRule(key) {
            const ruleToEdit = partRules.find(r => r.id === key);
            if(ruleToEdit) {
                document.getElementById('partRuleId').value = ruleToEdit.id;
                document.getElementById('partRuleCode').value = ruleToEdit.codigo;
                const container = document.getElementById('newPartChecklistContainer');
                container.innerHTML = '';
                ruleToEdit.checklist.forEach(item => addChecklistItemInput(container.id, item, 'part'));
                document.getElementById('cancelPartEdit').style.display = 'inline-flex';
            }
        }
        
        function saveRule() {
            const ruleId = document.getElementById('ruleId').value;
            const code = document.getElementById('ruleCode').value.trim();
            if (!code) { alert('Código é obrigatório.'); return; }
            const checklistItems = Array.from(document.querySelectorAll('#newChecklistContainer .checklist-item-wrapper')).map(w => ({
                text: w.querySelector('.new-checklist-item').value.trim(),
                symbol: w.querySelector('.checklist-item-symbol').value
            })).filter(item => item.text);
            const ruleData = { codigo: code, checklist: checklistItems };
            if (ruleId) { rulesRef.child(ruleId).update(ruleData); } else { rulesRef.push(ruleData); }
            resetRuleForm();
        }
        
        function savePartRule() {
            const ruleId = document.getElementById('partRuleId').value;
            const code = document.getElementById('partRuleCode').value.trim();
            if (!code) { alert('Código é obrigatório.'); return; }
            const checklistItems = Array.from(document.querySelectorAll('#newPartChecklistContainer .checklist-item-wrapper')).map(w => ({
                text: w.querySelector('.new-checklist-item').value.trim(),
                symbol: w.querySelector('.checklist-item-symbol').value,
                quantity: parseInt(w.querySelector('.checklist-item-quantity').value, 10) || 1
            })).filter(item => item.text);
            const ruleData = { codigo: code, checklist: checklistItems };
            if (ruleId) { rulesPartRef.child(ruleId).update(ruleData); } else { rulesPartRef.push(ruleData); }
            resetPartRuleForm();
        }
        
        function resetRuleForm() {
            document.getElementById('ruleId').value = '';
            document.getElementById('ruleCode').value = '';
            document.getElementById('newChecklistContainer').innerHTML = '';
            document.getElementById('cancelEdit').style.display = 'none';
        }
        function resetPartRuleForm() {
            document.getElementById('partRuleId').value = '';
            document.getElementById('partRuleCode').value = '';
            document.getElementById('newPartChecklistContainer').innerHTML = '';
            document.getElementById('cancelPartEdit').style.display = 'none';
        }

        const addChecklistItemInput = (containerId, itemData = {}, type = 'code') => {
            const container = document.getElementById(containerId);
            const wrapper = document.createElement('div');
            wrapper.className = 'checklist-item-wrapper';
            
            const handle = `<span class="drag-handle"><i data-feather="move" style="width:20px; height:20px; cursor: grab;"></i></span>`;
            const symbolSelect = `<select class="form-select checklist-item-symbol" style="width: 60px;"><option value="■">■</option><option value="▲">▲</option><option value="●">●</option><option value="*">*</option></select>`;
            const textInput = `<input type="text" placeholder="Item do checklist" class="new-checklist-item form-input" value="${itemData.text || ''}">`;
            let quantityInput = '';
            if (type === 'part') {
                quantityInput = `<input type="number" class="checklist-item-quantity form-input" value="${itemData.quantity || 1}" min="1" style="width: 80px;">`;
            }
            const deleteButton = `<button type="button" class="btn--icon" onclick="this.parentElement.remove()"><i data-feather="x-circle" style="width:20px; height:20px;"></i></button>`;
            
            wrapper.innerHTML = handle + symbolSelect + textInput + quantityInput + deleteButton;
            if(itemData.symbol) wrapper.querySelector('.checklist-item-symbol').value = itemData.symbol;
            container.appendChild(wrapper);
            feather.replace();
        };
        
        document.getElementById('addChecklistItem').addEventListener('click', () => addChecklistItemInput('newChecklistContainer'));
        document.getElementById('addPartChecklistItem').addEventListener('click', () => addChecklistItemInput('newPartChecklistContainer', {}, 'part'));
        document.getElementById('saveRule').addEventListener('click', saveRule);
        document.getElementById('savePartRule').addEventListener('click', savePartRule);
        document.getElementById('cancelEdit').addEventListener('click', resetRuleForm);
        document.getElementById('cancelPartEdit').addEventListener('click', resetPartRuleForm);


        // --- LÓGICA DE PROCESSAMENTO DE PLANILHA (RESTAURADA E COMPLETA) ---
        document.getElementById('fileInput').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            document.getElementById('status').textContent = `Processando "${file.name}"...`;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    fullSpreadsheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                    drawInitialTable(fullSpreadsheetData);
                    document.getElementById('status').textContent = `Exibindo dados de "${file.name}".`;
                    document.getElementById('saveClientButton').style.display = 'inline-flex';
                } catch (error) {
                    console.error("Erro ao processar o arquivo:", error);
                    document.getElementById('status').textContent = 'Ocorreu um erro ao ler o arquivo.';
                }
            };
            reader.readAsBinaryString(file);
        });
        
        function drawInitialTable(jsonData) {
            const tableContainer = document.getElementById('table-container');
            const spreadsheetHeaderContainer = document.getElementById('spreadsheet-header-container');
            tableContainer.innerHTML = '';
            spreadsheetHeaderContainer.innerHTML = '';

            let tableHeaderRowIndex = jsonData.findIndex(row => Array.isArray(row) && row.some(cell => String(cell).toUpperCase().includes('CÓDIGO')));
            if(tableHeaderRowIndex === -1) {
                document.getElementById('status').textContent = 'Aviso: A coluna "Código" não foi encontrada na planilha.';
                return;
            }

            const headerContent = document.createElement('div');
            headerContent.className = 'spreadsheet-header__content';
            jsonData.slice(0, tableHeaderRowIndex).forEach(row => {
                const filteredCells = row.filter(cell => cell !== null && String(cell).trim() !== '');
                if (filteredCells.length > 0) {
                    const p = document.createElement('p');
                    p.className = 'spreadsheet-header__line';
                    if (String(filteredCells[0]).toLowerCase().includes('planilha de itens')) {
                        p.innerHTML = `<strong>${filteredCells.join(' ')}</strong>`;
                        p.classList.add('spreadsheet-header__line--title');
                    } else {
                        p.textContent = filteredCells.join(' \u00A0\u00A0\u00A0 ');
                    }
                    headerContent.appendChild(p);
                }
            });
            spreadsheetHeaderContainer.appendChild(headerContent);
            
            const header = jsonData[tableHeaderRowIndex];
            const tableData = jsonData.slice(tableHeaderRowIndex + 1);
            const table = document.createElement('table');
            table.className = "data-table";
            table.innerHTML = `<thead><tr>${header.map(h => `<th class="data-table__th">${h}</th>`).join('')}</tr></thead>
                             <tbody>${tableData.map(rowData => `<tr>${rowData.map(cell => `<td class="data-table__td">${cell}</td>`).join('')}</tr>`).join('')}</tbody>`;
            tableContainer.appendChild(table);
        }

        document.getElementById('saveClientButton').addEventListener('click', () => {
            if (fullSpreadsheetData.length === 0) { alert('Nenhuma planilha carregada.'); return; }
            const clientName = prompt("Digite o nome do cliente/obra:", `Cliente ${new Date().toLocaleDateString()}`);
            if(!clientName) return;
            const clientData = { name: clientName, spreadsheetData: fullSpreadsheetData, createdAt: new Date().toISOString() };
            database.ref('dados/producao_clientes').push(clientData)
                .then(() => alert(`Cliente "${clientName}" salvo com sucesso!`))
                .catch(error => alert("Erro ao salvar."));
        });

        // --- LÓGICA DA TELA DE CLIENTES (RESTAURADA E COMPLETA) ---
        function loadClientsList() {
            const listBody = document.getElementById('production-clients-list');
            listBody.innerHTML = '<tr><td colspan="2">Carregando...</td></tr>';
            const clientsRef = database.ref('dados/producao_clientes');
            clientsRef.on('value', snapshot => {
                listBody.innerHTML = '';
                const clients = snapshot.val();
                if (clients) {
                    Object.entries(clients).forEach(([clientId, client]) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="data-table__td">${client.name}</td>
                            <td class="data-table__td">
                                <div style="display: flex; gap: 0.5rem; justify-content: flex-start;">
                                    <button class="btn btn--primary" onclick="showProductionItemView('${clientId}')">Ver Ordem</button>
                                    <button class="btn btn--success" onclick="generateDocument('${clientId}', 'producao')">Produção</button>
                                    <button class="btn btn--secondary" onclick="generateDocument('${clientId}', 'romaneio')">Romaneio</button>
                                    <button class="btn btn--warning btn--icon" title="Compartilhar Link" onclick="shareOrderLink('${clientId}')"><i data-feather="share-2"></i></button>
                                </div>
                            </td>`;
                        listBody.appendChild(row);
                    });
                } else {
                    listBody.innerHTML = '<tr><td colspan="2">Nenhum cliente em produção.</td></tr>';
                }
                feather.replace();
            });
        }
        
        function shareOrderLink(clientId) {
            const shareUrl = `${window.location.href.split('#')[0]}#order=${clientId}`;
            navigator.clipboard.writeText(shareUrl).then(() => alert('Link copiado!'));
        }

        // --- LÓGICA DE GERAÇÃO DE DOCUMENTOS (CORRIGIDA E COMPLETA) ---
        async function generateDocument(clientId, mode) {
            try {
                const clientSnapshot = await database.ref(`dados/producao_clientes/${clientId}`).once('value');
                const clientData = clientSnapshot.val();
                if (!clientData || !clientData.spreadsheetData) { alert('Erro: Dados do cliente não encontrados.'); return; }

                const rulesPath = (mode === 'producao') ? 'dados/producao' : 'dados/romaneio';
                const partRulesPath = (mode === 'producao') ? 'dados/producaoPecas' : 'dados/romaneioPecas';

                const [rulesSnapshot, partRulesSnapshot] = await Promise.all([
                    database.ref(rulesPath).once('value'),
                    database.ref(partRulesPath).once('value')
                ]);
                
                const loadedRules = [];
                const rulesData = rulesSnapshot.val();
                if(rulesData) Object.entries(rulesData).forEach(([id, data]) => loadedRules.push({id, ...data}));

                const loadedPartRules = [];
                const partRulesData = partRulesSnapshot.val();
                if(partRulesData) Object.entries(partRulesData).forEach(([id, data]) => loadedPartRules.push({id, ...data}));

                renderDocument(clientData.spreadsheetData, loadedRules, loadedPartRules, mode);
            } catch (error) {
                console.error("Erro ao gerar documento:", error);
                alert("Ocorreu um erro ao gerar o documento.");
            }
        }

        function renderDocument(spreadsheetData, documentRules, documentPartRules, mode) {
            const romaneioHeaderContainer = document.getElementById('romaneio-header');
            const romaneioItemsContainer = document.getElementById('romaneio-items');
            romaneioHeaderContainer.innerHTML = '';
            romaneioItemsContainer.innerHTML = '';

            const tableHeaderRowIndex = spreadsheetData.findIndex(row => Array.isArray(row) && row.some(cell => String(cell).toUpperCase().includes('CÓDIGO')));
            if (tableHeaderRowIndex === -1) { alert("Cabeçalho 'CÓDIGO' não encontrado na planilha salva."); return; }
            
            const tableHeader = spreadsheetData[tableHeaderRowIndex];
            const codeColumnIndex = tableHeader.findIndex(h => String(h).toUpperCase().includes('CÓDIGO'));
            const descColumnIndex = tableHeader.findIndex(h => String(h).toUpperCase().includes('DESCRIÇÃO'));
            const tipoColumnIndex = tableHeader.findIndex(h => String(h).toUpperCase() === 'TIPO');

            const title = mode === 'producao' ? 'Relatório de Produção' : 'Romaneio de Conferência';
            const spreadsheetHeaderData = spreadsheetData.slice(0, tableHeaderRowIndex);
            spreadsheetHeaderData.forEach(row => {
                const filteredCells = row.filter(cell => cell !== null && String(cell).trim() !== '');
                if (filteredCells.length > 0) {
                    const p = document.createElement('p');
                    if (String(filteredCells[0]).toLowerCase().includes('planilha de itens')) {
                        p.innerHTML = `<strong>${title}</strong>`;
                    } else {
                        p.innerHTML = filteredCells.map(cell => `<span>${cell}</span>`).join('<span style="margin: 0 1rem;">|</span>');
                    }
                    romaneioHeaderContainer.appendChild(p);
                }
            });

            const tableData = spreadsheetData.slice(tableHeaderRowIndex + 1);
            tableData.forEach((rowData, index) => {
                const itemCode = String(rowData[codeColumnIndex] || '').trim().toUpperCase();
                if (!itemCode) return;

                const itemDesc = descColumnIndex !== -1 ? String(rowData[descColumnIndex] || '') : 'Sem descrição';
                const itemTipo = tipoColumnIndex !== -1 ? String(rowData[tipoColumnIndex] || '') : '';
                const itemPos = String(rowData[0] || index + 1);

                let combinedChecklist = [];
                documentPartRules.filter(r => itemCode.includes(r.codigo.toUpperCase())).forEach(r => r.checklist.forEach(i => combinedChecklist.push(i)));
                documentRules.filter(r => itemCode.includes(r.codigo.toUpperCase())).forEach(r => r.checklist.forEach(i => combinedChecklist.push({ ...i, quantity: 1 })));

                let checklistHTML = `<h4 class="romaneio-item__checklist-title">Checklist de Conferência</h4>`;
                if (combinedChecklist.length > 0) {
                    combinedChecklist.forEach(checkItem => {
                        let boxesHTML = '';
                        for (let i = 0; i < (checkItem.quantity || 1); i++) {
                            boxesHTML += '<div class="romaneio-item__checkbox-box"></div>';
                        }
                        checklistHTML += `
                            <div class="romaneio-item__checklist-item">
                                <div><span class="romaneio-item__symbol">${checkItem.symbol || '■'}</span><span>${checkItem.text}</span></div>
                                <div class="romaneio-item__checkbox-group">${boxesHTML}</div>
                            </div>`;
                    });
                } else {
                    checklistHTML += '<p style="font-size: 0.9rem; color: var(--color-text-light);">Nenhum checklist para este item.</p>';
                }

                const imageMapping = { PCR: 'pcr.png', JCR: 'jcr.png', PGR: 'pgr.png', FIX: 'fix.png', ABT: 'abt.png', IPC: 'ipc.png', IJC: 'ijc.png', PIV: 'piv.png', MAX: 'max.png' };
                let imageHTML = '';
                for (const key in imageMapping) {
                    if (itemCode.includes(key)) {
                        imageHTML = `<img src="${imageMapping[key]}" class="romaneio-item__image" alt="${key}">`;
                        break;
                    }
                }
                
                const itemCard = document.createElement('div');
                itemCard.className = 'romaneio-item';
                itemCard.innerHTML = `
                    <div class="romaneio-item__info">
                        <p class="romaneio-item__pos">Pos. ${itemPos}</p>
                        <p class="romaneio-item__code">${itemCode}</p>
                        <p class="romaneio-item__desc">${itemDesc}</p>
                        ${itemTipo ? `<p class="romaneio-item__tipo">${itemTipo}</p>` : ''}
                        ${imageHTML}
                    </div>
                    <div class="romaneio-item__checklist">${checklistHTML}</div>`;
                romaneioItemsContainer.appendChild(itemCard);
            });
            
            const observationNotes = document.getElementById('observation-notes');
            if (observationNotes && observationNotes.value.trim() !== '') {
                const observationSection = document.createElement('div');
                observationSection.className = 'romaneio-observations';
                observationSection.innerHTML = `
                    <h4 class="romaneio-item__checklist-title">Observações</h4>
                    <p style="white-space: pre-wrap;">${observationNotes.value}</p>
                `;
                romaneioItemsContainer.appendChild(observationSection);
            }

            const signatureSection = document.createElement('div');
            signatureSection.className = 'romaneio-signatures';
            signatureSection.innerHTML = `<div class="signature-line"><div></div><p>Assinatura Conferente</p></div><div class="signature-line"><div></div><p>Assinatura do Supervisor</p></div>`;
            romaneioItemsContainer.appendChild(signatureSection);
            
            document.getElementById('romaneioModal').style.display = 'flex';
        }
        
        // --- LÓGICA DO CHECKLIST INTERATIVO "VER ORDEM" (RESTAURADA) ---
        async function showProductionItemView(clientId) {
            itemView.style.display = 'block';
            mainContainer.style.display = 'none';
            clientsView.style.display = 'none';
            
            itemView.innerHTML = '<div class="view__content"><h2>Carregando dados da ordem...</h2></div>';

            try {
                const [clientSnapshot, rulesSnapshot, partRulesSnapshot] = await Promise.all([
                    database.ref(`dados/producao_clientes/${clientId}`).once('value'),
                    database.ref('dados/producao').once('value'),
                    database.ref('dados/producaoPecas').once('value')
                ]);

                const clientData = clientSnapshot.val();
                if (!clientData) { itemView.innerHTML = '<div class="view__content"><h2>Erro: Cliente não encontrado.</h2></div>'; return; }

                const productionRules = [];
                const rulesData = rulesSnapshot.val();
                if(rulesData) Object.entries(rulesData).forEach(([id, data]) => productionRules.push({id, ...data}));

                const productionPartRules = [];
                const partRulesData = partRulesSnapshot.val();
                if(partRulesData) Object.entries(partRulesData).forEach(([id, data]) => productionPartRules.push({id, ...data}));

                let contentHTML = `<div class="view__content">
                                    <h2 class="view__title">Acompanhamento: ${clientData.name}</h2>
                                    <button class="btn btn--secondary" style="margin-bottom: 2rem; max-width: 200px;" onclick="showClientsView()"><i data-feather="arrow-left"></i> <span>Voltar para Clientes</span></button>
                                   </div>`;
                
                const tableHeaderRowIndex = clientData.spreadsheetData.findIndex(row => Array.isArray(row) && row.some(cell => String(cell).toUpperCase().includes('CÓDIGO')));
                const tableHeader = clientData.spreadsheetData[tableHeaderRowIndex];
                const codeColumnIndex = tableHeader.findIndex(h => String(h).toUpperCase().includes('CÓDIGO'));
                const descColumnIndex = tableHeader.findIndex(h => String(h).toUpperCase().includes('DESCRIÇÃO'));
                
                const tableData = clientData.spreadsheetData.slice(tableHeaderRowIndex + 1);
                tableData.forEach((rowData, index) => {
                    const itemCode = String(rowData[codeColumnIndex] || '').trim().toUpperCase();
                    if (!itemCode) return;

                    const itemPos = String(rowData[0] || index + 1);
                    const itemDesc = descColumnIndex !== -1 ? String(rowData[descColumnIndex] || '') : 'Sem descrição';
                    
                    const imageMapping = { PCR: 'pcr.png', JCR: 'jcr.png', PGR: 'pgr.png', FIX: 'fix.png', ABT: 'abt.png', IPC: 'ipc.png', IJC: 'ijc.png', PIV: 'piv.png', MAX: 'max.png' };
                    let imageHTML = '';
                    for (const key in imageMapping) {
                        if (itemCode.includes(key)) {
                            imageHTML = `<img src="${imageMapping[key]}" class="conference-item__image" alt="${key}">`;
                            break;
                        }
                    }

                    let combinedChecklist = [];
                    productionPartRules.filter(r => itemCode.includes(r.codigo.toUpperCase())).forEach(r => r.checklist.forEach(i => combinedChecklist.push(i)));
                    productionRules.filter(r => itemCode.includes(r.codigo.toUpperCase())).forEach(r => r.checklist.forEach(i => combinedChecklist.push({ ...i, quantity: 1 })));

                    let checklistHTML = `<h4 class="romaneio-item__checklist-title">Checklist Interativo</h4>`;
                    if(combinedChecklist.length > 0) {
                        combinedChecklist.forEach((checkItem, checkIndex) => {
                            const safeItemText = (checkItem.text || '').replace(/[^a-zA-Z0-9]/g, '');
                            const checkId = `check-${clientId}-${itemPos}-${safeItemText}-${checkIndex}`;
                            checklistHTML += `
                                <div class="interactive-checklist-item">
                                    <label for="${checkId}">
                                        <input type="checkbox" id="${checkId}" onchange="updateChecklistStatus('${clientId}', '${itemPos}', '${checkItem.text.replace(/'/g, "\\'")}', this.checked)">
                                        <span>${checkItem.text}</span>
                                    </label>
                                </div>`;
                        });
                    }
                    
                    contentHTML += `
                        <div class="conference-item view__content">
                            <div class="conference-item__image-wrapper">${imageHTML}</div>
                            <div class="conference-item__info">
                                <p class="conference-item__pos">Pos. ${itemPos}</p>
                                <p class="conference-item__code">${itemCode}</p>
                                <p class="conference-item__desc">${itemDesc}</p>
                            </div>
                            <div class="conference-item__checklist">${checklistHTML}</div>
                        </div>`;
                });
                itemView.innerHTML = contentHTML;
                feather.replace();
                
                database.ref(`dados/producao_checklist_status/${clientId}`).on('value', statusSnapshot => {
                    const statuses = statusSnapshot.val();
                    if(statuses) {
                        Object.entries(statuses).forEach(([itemPos, itemStatuses]) => {
                            Object.entries(itemStatuses).forEach(([itemText, isChecked]) => {
                                const safeItemText = (itemText || '').replace(/[^a-zA-Z0-9]/g, '');
                                // Precisa reconstruir o combinedChecklist para encontrar o checkIndex
                                const itemRow = tableData.find(row => (row[0] || '') == itemPos);
                                if(itemRow) {
                                    const itemCode = String(itemRow[codeColumnIndex] || '').trim().toUpperCase();
                                    let tempCombinedChecklist = [];
                                    productionPartRules.filter(r => itemCode.includes(r.codigo.toUpperCase())).forEach(r => r.checklist.forEach(i => tempCombinedChecklist.push(i)));
                                    productionRules.filter(r => itemCode.includes(r.codigo.toUpperCase())).forEach(r => r.checklist.forEach(i => tempCombinedChecklist.push({ ...i, quantity: 1 })));
                                    
                                    const checkIndex = tempCombinedChecklist.findIndex(item => item.text === itemText);
                                    if(checkIndex !== -1) {
                                        const checkId = `check-${clientId}-${itemPos}-${safeItemText}-${checkIndex}`;
                                        const checkbox = document.getElementById(checkId);
                                        if (checkbox) {
                                            checkbox.checked = isChecked;
                                        }
                                    }
                                }
                            });
                        });
                    }
                });
            } catch (error) {
                console.error("Erro ao carregar ordem:", error);
                itemView.innerHTML = '<div class="view__content"><h2>Ocorreu um erro ao carregar a ordem.</h2></div>';
            }
        }
        function updateChecklistStatus(clientId, itemPos, itemText, isChecked) {
            database.ref(`dados/producao_checklist_status/${clientId}/${itemPos}`).update({ [itemText]: isChecked });
        }
        
        // --- LÓGICA DE ANÁLISE DE TABELA (RESTAURADA) ---
        async function analyzeCurrentTable() {
            const analysisResultContainer = document.getElementById('analysisResult');
            analysisResultContainer.innerHTML = 'Analisando...';
        
            const table = document.querySelector('#table-container table');
            if (!table || fullSpreadsheetData.length === 0) {
                analysisResultContainer.innerHTML = '<p class="analysis-result__item analysis-result__item--fail">Nenhuma tabela para analisar. Carregue uma planilha primeiro.</p>';
                return;
            }
        
            try {
                const [rulesSnapshot, partRulesSnapshot] = await Promise.all([
                    database.ref('dados/producao').once('value'),
                    database.ref('dados/producaoPecas').once('value')
                ]);
        
                const analysisRules = [];
                if(rulesSnapshot.val()) Object.values(rulesSnapshot.val()).forEach(data => analysisRules.push(data));
        
                const analysisPartRules = [];
                if(partRulesSnapshot.val()) Object.values(partRulesSnapshot.val()).forEach(data => analysisPartRules.push(data));
        
                const headerRow = table.querySelector('thead tr');
                const codeColIndex = Array.from(headerRow.cells).findIndex(th => th.textContent.toUpperCase().includes('CÓDIGO'));
        
                if (codeColIndex === -1) {
                    analysisResultContainer.innerHTML = '<p class="analysis-result__item analysis-result__item--fail">Coluna "CÓDIGO" não encontrada na tabela.</p>';
                    return;
                }
        
                analysisResultContainer.innerHTML = ''; 
                const dataRows = Array.from(table.querySelectorAll('tbody tr'));
        
                dataRows.forEach((row, rowIndex) => {
                    const codeCell = row.cells[codeColIndex];
                    const itemCode = (codeCell.textContent || '').trim().toUpperCase();
                    if (!itemCode) return;
        
                    const hasCodeRule = analysisRules.some(rule => itemCode.includes(rule.codigo.toUpperCase()));
                    const hasPartRule = analysisPartRules.some(rule => itemCode.includes(rule.codigo.toUpperCase()));
        
                    const resultEl = document.createElement('p');
                    resultEl.className = 'analysis-result__item';
        
                    if (hasCodeRule || hasPartRule) {
                        resultEl.textContent = `Linha ${rowIndex + 1} (Código: ${itemCode}): REGRA ENCONTRADA`;
                        resultEl.classList.add('analysis-result__item--success');
                    } else {
                        resultEl.textContent = `Linha ${rowIndex + 1} (Código: ${itemCode}): Nenhuma regra encontrada`;
                        resultEl.classList.add('analysis-result__item--fail');
                    }
                    analysisResultContainer.appendChild(resultEl);
                });
        
            } catch (error) {
                console.error("Erro ao analisar tabela:", error);
                analysisResultContainer.innerHTML = '<p class="analysis-result__item analysis-result__item--fail">Ocorreu um erro durante a análise.</p>';
            }
        }


        // --- INICIALIZAÇÃO ---
        window.addEventListener('load', () => {
            if (window.location.hash && window.location.hash.startsWith('#order=')) {
                const clientId = window.location.hash.substring(7);
                if (clientId) {
                    showProductionItemView(clientId);
                }
            } else {
                 showMainView();
            }
        });
        feather.replace();
    </script>
</body>
</html>
