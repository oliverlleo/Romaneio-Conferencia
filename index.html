<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor de Planilha com Regras | Flat Design</title>

    <!-- SDKs do Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <!-- Biblioteca SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Biblioteca PapaParse para exportar CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Fontes e Ícones -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        :root {
            --font-family-sans: 'Montserrat', sans-serif; --color-text: #1E293B; --color-text-light: #64748B; --color-bg: #F1F5F9; --color-panel-bg: #FFFFFF; --color-border: #E2E8F0; --color-accent-primary: #0D9488; --color-accent-primary-hover: #0F766E; --color-accent-secondary: #475569; --color-accent-secondary-hover: #334155; --color-success: #16A34A; --color-success-hover: #15803D; --color-danger: #DC2626; --color-danger-hover: #B91C1C; --color-warning: #D97706; --color-warning-hover: #B45309;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; }
        body { font-family: var(--font-family-sans); background-color: var(--color-bg); color: var(--color-text); line-height: 1.5; -webkit-font-smoothing: antialiased; }
        .app-container { display: none; width: 100%; max-width: 1400px; margin: 2rem auto; padding: 2rem; background-color: var(--color-panel-bg); border-radius: 8px; }
        .app-header { font-size: 2rem; font-weight: 700; text-align: center; margin-bottom: 2rem; color: var(--color-text); }
        .action-bar { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; }
        .status-text { text-align: center; margin: 2rem 0; color: var(--color-text-light); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1.5rem; border: none; border-radius: 6px; font-family: var(--font-family-sans); font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s ease; text-decoration: none; flex-grow: 1; }
        .btn i { width: 18px; height: 18px; }
        .btn--primary { background-color: var(--color-accent-primary); color: white; }
        .btn--primary:hover { background-color: var(--color-accent-primary-hover); }
        .btn--secondary { background-color: var(--color-accent-secondary); color: white; }
        .btn--secondary:hover { background-color: var(--color-accent-secondary-hover); }
        .btn--success { background-color: var(--color-success); color: white; }
        .btn--success:hover { background-color: var(--color-success-hover); }
        .btn--warning { background-color: var(--color-warning); color: white; }
        .btn--warning:hover { background-color: var(--color-warning-hover); }
        .btn--danger { background-color: var(--color-danger); color: white; }
        .btn--danger:hover { background-color: var(--color-danger-hover); }
        .btn--text { background-color: transparent; color: var(--color-accent-primary); padding: 0.25rem; justify-content: flex-start; flex-grow: 0; border-radius: 4px; }
        .btn--text:hover { color: var(--color-accent-primary-hover); background-color: var(--color-bg); }
        .btn--icon { background: transparent; border: 1px solid var(--color-border); color: var(--color-text-light); padding: 0.75rem; cursor: pointer; line-height: 1; flex-grow: 0; border-radius: 6px; }
        .btn--icon:hover { color: var(--color-accent-primary); border-color: var(--color-accent-primary); background-color: #F0FDFA; }
        .btn--icon.btn--danger:hover { color: var(--color-danger); border-color: var(--color-danger); background-color: #FEE2E2; }
        .file-input { display: none; }
        .view { display: none; width: 100%; }
        .view__title { font-size: 2rem; font-weight: 700; margin-bottom: 2rem; color: var(--color-text); }
        .view__content { max-width: 1400px; margin: 2rem auto; padding: 2rem; background-color: var(--color-panel-bg); border-radius: 8px; }
        .view__content--large { max-width: 1600px; }
        .modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(30, 41, 59, 0.8); align-items: center; justify-content: center; }
        .modal__content { background-color: var(--color-panel-bg); padding: 2.5rem; border-radius: 8px; width: 90%; max-width: 700px; position: relative; max-height: 90vh; overflow-y: auto; }
        .modal__content--large { max-width: 1100px; }
        .modal__content--xlarge { max-width: 1600px; }
        .modal__close { color: var(--color-text-light); position: absolute; top: 1rem; right: 1.5rem; font-size: 2rem; font-weight: bold; cursor: pointer; line-height: 1; }
        .modal__close:hover { color: var(--color-text); }
        .modal__section { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--color-border); }
        .modal__subtitle { font-size: 1rem; margin-bottom: 1rem; color: var(--color-text-light); }
        .form-grid { display: grid; gap: 1rem; }
        .form-input, .form-textarea, .form-select { width: 100%; padding: 0.75rem; border-radius: 6px; font-family: var(--font-family-sans); font-size: 1rem; background-color: var(--color-bg); border: 1px solid var(--color-border); color: var(--color-text); }
        .form-input:focus, .form-textarea:focus, .form-select:focus { outline: 2px solid var(--color-accent-primary); border-color: var(--color-accent-primary); }
        .checklist-item-wrapper { display: flex; align-items: center; gap: 0.5rem; }
        .drag-handle { cursor: grab; color: var(--color-text-light); }
        .checklist-item-wrapper.dragging { opacity: 0.5; background: var(--color-border); }
        .spreadsheet-header { margin-bottom: 1.5rem; }
        .spreadsheet-header__content { background-color: var(--color-bg); padding: 1.5rem; border-radius: 8px; }
        .spreadsheet-header__line { margin-bottom: 0.5rem; }
        .spreadsheet-header__line--title { font-size: 1.25rem; font-weight: 700; }
        .table-wrapper { width: 100%; overflow-x: auto; border: 1px solid var(--color-border); border-radius: 8px; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table__th, .data-table__td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--color-border); white-space: nowrap; }
        .data-table tr:last-child .data-table__td { border-bottom: none; }
        .data-table__th { background-color: var(--color-bg); font-weight: 600; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--color-text-light); }
        .rules-list, .generic-list { display: grid; gap: 1rem; }
        .rule-item, .generic-list-item { background-color: var(--color-bg); padding: 1rem; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .rule-item__info, .generic-list-item__info { flex-grow: 1; }
        .rule-item__actions, .generic-list-item__actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
        .rule-item__code { font-weight: 600; }
        .rule-item__checklist { list-style-position: inside; padding-left: 0.5rem; color: var(--color-text-light); font-size: 0.9rem; }
        .analysis-result { background-color: var(--color-bg); padding: 1rem; max-height: 60vh; overflow-y: auto; border-radius: 6px; }
        .analysis-result__item { padding: 0.5rem 1rem; margin-bottom: 0.5rem; border-radius: 4px; }
        .analysis-result__item--success { background-color: #D1FAE5; color: #065F46; }
        .analysis-result__item--fail { background-color: #FEE2E2; color: #991B1B; }
        .romaneio-page, .checklist-page { flex-grow: 1; overflow-y: auto; background-color: var(--color-panel-bg); padding: 2rem; }
        .romaneio-header { margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid var(--color-text); }
        .romaneio-header p { margin-bottom: 0.25rem; }
        .romaneio-header strong { font-size: 1.5rem; display: block; margin-bottom: 1rem; }
        .romaneio-item { padding: 1.5rem 0; display: flex; gap: 2rem; border-bottom: 1px solid var(--color-border); }
        .romaneio-item__info { flex-grow: 1; }
        .romaneio-item__pos { font-size: 0.9rem; color: var(--color-text-light); font-weight: 500; }
        .romaneio-item__code { font-size: 1.2rem; font-weight: 700; }
        .romaneio-item__desc { font-size: 1rem; color: var(--color-text-light); }
        .romaneio-item__tipo { font-size: 1.2rem; font-weight: 700; color: var(--color-danger); margin-top: 0.25rem; }
        .romaneio-item__image { max-width: 40%; height: auto; margin-top: 1rem; border-radius: 6px; }
        .romaneio-item__checklist { flex-shrink: 0; width: 40%; border-left: 1px solid var(--color-border); padding-left: 2rem; }
        .romaneio-item__checklist-title { font-weight: 600; margin-bottom: 1rem; }
        .romaneio-item__checklist-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem; }
        .romaneio-item__checkbox-group { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .romaneio-item__checkbox-box { width: 20px; height: 20px; border: 2px solid var(--color-text-light); border-radius: 4px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--color-accent-primary); }
        .romaneio-item__symbol { margin-right: 0.5rem; font-size: 1.2rem; line-height: 1; }
        .romaneio-footer { padding: 1.5rem 2rem; background-color: var(--color-bg); display: flex; gap: 1rem; justify-content: flex-end; }
        .romaneio-observations { border-top: 1px solid var(--color-border); padding-top: 1.5rem; margin-top: 1.5rem; }
        .romaneio-signatures { padding-top: 4rem; margin-top: 4rem; display: flex; justify-content: space-around; }
        .signature-line { text-align: center; }
        .signature-line > div { border-top: 1px solid var(--color-text); width: 200px; margin-bottom: 0.5rem; }
        .config-view { display: none; }
        .config-view.active { display: block; }
        
        /* --- ESTILOS DO MODAL DE TRATAMENTO --- */
        .treatment-header { margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--color-border); }
        .section-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem; color: var(--color-text); }
        .treatment-layout { display: grid; grid-template-columns: 2.5fr 1fr; gap: 2.5rem; }
        .treatment-summary-sidebar { display: flex; flex-direction: column; gap: 1.5rem; }
        .summary-card { background-color: var(--color-panel-bg); border-radius: 8px; padding: 1.5rem; border: 1px solid var(--color-border); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05); }
        #total-geral-summary { background: linear-gradient(145deg, var(--color-accent-primary), #14B8A6); color: white; text-align: center; }
        #total-geral-summary .total-label { font-size: 1rem; font-weight: 500; opacity: 0.9; margin-bottom: 0.5rem; }
        #total-geral-summary .total-value { font-size: 2.5rem; font-weight: 700; line-height: 1; }
        .summary-card__title { font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: var(--color-accent-secondary); }
        .table-wrapper--condensed { max-height: 250px; overflow-y: auto; }
        .summary-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .summary-table th, .summary-table td { padding: 0.5rem; text-align: left; border-bottom: 1px solid var(--color-border); }
        .summary-table th { font-weight: 600; color: var(--color-text-light); font-size: 0.75rem; text-transform: uppercase; }
        .summary-table tr:last-child td { border-bottom: none; }
        .summary-table td:last-child { text-align: right; font-weight: 700; }
        #treatmentResultTable { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        #treatmentResultTable th, #treatmentResultTable td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--color-border); white-space: normal; }
        #treatmentResultTable th { background-color: var(--color-bg); font-weight: 600; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--color-text-light); }
        #treatmentResultTable tbody tr:nth-child(even) { background-color: #F8FAFC; }
        #treatmentResultTable tbody tr:hover { background-color: #F1F5F9; }

        /* --- [INÍCIO] ESTILOS DE ACESSIBILIDADE PARA CHECKLIST ONLINE --- */
        .checklist-page .romaneio-item__checklist-item {
            padding: 0.5rem 0; /* Adiciona espaçamento vertical */
        }
        .checklist-page .romaneio-item__checkbox-group input[type="checkbox"] {
            width: 28px;  /* Aumenta o tamanho do checkbox */
            height: 28px; /* Aumenta o tamanho do checkbox */
            cursor: pointer;
        }
        .checklist-page .romaneio-item__checklist-item > div:first-child {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.1rem; /* Aumenta o tamanho da fonte do texto */
        }
        /* --- [FIM] ESTILOS DE ACESSIBILIDADE PARA CHECKLIST ONLINE --- */

        /* --- [INÍCIO] ESTILOS CORRIGIDOS PARA O CHECKLIST ONLINE --- */
        .checklist-page .romaneio-item__info {
            display: flex;
            align-items: flex-start;
            gap: 1.5rem;
        }
        .checklist-page .romaneio-item__image {
            max-width: 120px;
            flex-shrink: 0;
            margin-top: 0;
        }
        /* --- [FIM] ESTILOS CORRIGIDOS PARA O CHECKLIST ONLINE --- */

        /* --- ESTILOS RESPONSIVOS PARA CHECKLISTS --- */
        @media (max-width: 768px) {
            .view__content {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            .romaneio-item {
                flex-direction: column;
            }
            .romaneio-item__checklist {
                width: 100%;
                border-left: none;
                padding-left: 0;
                margin-top: 1.5rem;
                padding-top: 1.5rem;
                border-top: 1px solid var(--color-border);
            }
            .checklist-page .romaneio-item__top {
                display: flex;
                flex-direction: row;
                gap: 1.5rem;
                align-items: flex-start;
            }
            .checklist-page .romaneio-item__image {
                max-width: 100px;
                flex-shrink: 0;
            }
        }

        @media (max-width: 1100px) {
            .treatment-layout {
                grid-template-columns: 1fr;
            }
        }
        
        @media print { @page { size: A4; margin: 1cm; } body { background-color: #fff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; } body > *:not(#romaneioModal):not(#treatmentModal), .modal__close, .romaneio-footer { display: none !important; } #romaneioModal, #romaneioModal .modal__content, .romaneio-page, #treatmentModal, #treatmentModal .modal__content { position: static !important; display: block !important; width: 100% !important; height: auto !important; overflow: visible !important; background: transparent !important; border: none !important; box-shadow: none !important; padding: 0 !important; margin: 0 !important; } .romaneio-item { page-break-inside: avoid; } }
    </style>
</head>
<body>

    <main class="app-container">
        <h1 class="app-header">Leitor de Planilhas com Regras</h1>
        <div class="action-bar">
            <label for="fileInput" class="btn btn--primary"><i data-feather="file-plus"></i> <span>Selecionar Planilha</span></label>
            <input type="file" id="fileInput" class="file-input" accept=".xlsx, .xls, .csv">
            <button id="configButton" class="btn btn--secondary"><i data-feather="settings"></i> <span>Configurações</span></button>
            <button id="analyzeTableButton" class="btn btn--warning"><i data-feather="bar-chart-2"></i> <span>Analisar Tabela</span></button>
            <button id="accessClientsButton" class="btn btn--primary"><i data-feather="users"></i> <span>Acessar Clientes</span></button>
            <button id="saveClientButton" class="btn btn--success" style="display: none;"><i data-feather="save"></i> <span>Salvar Cliente</span></button>
        </div>
        <p id="status" class="status-text">Nenhum arquivo selecionado.</p>
        <div id="spreadsheet-header-container" class="spreadsheet-header"></div>
        <div id="table-container" class="table-wrapper">
             <!-- A tabela da planilha carregada aparece aqui -->
        </div>
        <textarea id="observation-notes" class="form-textarea" rows="4" placeholder="Adicione observações para o relatório final aqui..." style="margin-top: 1rem;"></textarea>
    </main>

    <!-- VIEWS DE TELA CHEIA -->
    <div id="clients-view" class="view">
        <div class="view__content">
            <h2 class="view__title">Clientes em Produção</h2>
            <button class="btn btn--secondary" style="margin-bottom: 2rem; max-width: 200px;" onclick="showMainView()">
                <i data-feather="arrow-left"></i> <span>Voltar</span>
            </button>
            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="data-table__th">Nome do Cliente</th>
                            <th class="data-table__th">Total pç</th>
                            <th class="data-table__th">Andamento</th>
                            <th class="data-table__th">Etapa</th>
                            <th class="data-table__th">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="production-clients-list"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="romaneio-checklist-view" class="view">
        <!-- Conteúdo do checklist interativo de romaneio será injetado aqui -->
    </div>
    
    <div id="production-checklist-view" class="view">
        <!-- Conteúdo do checklist interativo de produção (compartilhável) será injetado aqui -->
    </div>

    <!-- MODAL DE CONFIGURAÇÕES -->
    <div id="configModal" class="modal">
        <div class="modal__content modal__content--large">
            <span class="modal__close" onclick="this.parentElement.parentElement.style.display='none'">&times;</span>
            <h2 class="modal__title">Configurações Gerais</h2>
            <div class="action-bar" style="margin-bottom: 2rem;">
                <button onclick="showConfigView('regras')" class="btn btn--secondary">Regras</button>
                <button onclick="showConfigView('funcionarios')" class="btn btn--secondary">Funcionários</button>
                <button onclick="showConfigView('servicos')" class="btn btn--secondary">Serviços</button>
            </div>

            <!-- Seção de Regras -->
            <div id="config-view-regras" class="config-view">
                <div class="action-bar" style="margin-bottom: 2rem;">
                    <button id="config-mode-romaneio" class="btn btn--secondary">Regras de Romaneio</button>
                    <button id="config-mode-producao" class="btn btn--secondary">Regras de Produção</button>
                </div>
                <div id="rule-form-section" class="modal__section">
                    <h3 id="rule-form-title" class="modal__subtitle">Regras de Código</h3>
                    <div class="form-grid">
                        <input type="hidden" id="ruleId">
                        <input type="text" id="ruleCode" placeholder="Se o código CONTÉM..." class="form-input">
                        <div id="newChecklistContainer"></div>
                        <button id="addChecklistItem" class="btn btn--text"><i data-feather="plus"></i> Adicionar item</button>
                        <button id="saveRule" class="btn btn--success">Salvar Regra de Código</button>
                        <button id="cancelEdit" class="btn btn--secondary" style="display: none;">Cancelar Edição</button>
                    </div>
                </div>
                <div class="modal__section">
                    <h3 class="modal__subtitle">Regras de Código Salvas</h3>
                    <div id="rulesList" class="rules-list"></div>
                </div>
                <div id="part-rule-form-section" class="modal__section">
                    <h3 id="part-rule-form-title" class="modal__subtitle">Regras de Peça</h3>
                    <div class="form-grid">
                        <input type="hidden" id="partRuleId">
                        <input type="text" id="partRuleCode" placeholder="Se o código CONTÉM..." class="form-input">
                        <div id="newPartChecklistContainer"></div>
                        <button id="addPartChecklistItem" class="btn btn--text"><i data-feather="plus"></i> Adicionar item de peça</button>
                        <button id="savePartRule" class="btn btn--success">Salvar Regra de Peça</button>
                        <button id="cancelPartEdit" class="btn btn--secondary" style="display: none;">Cancelar Edição</button>
                    </div>
                </div>
                 <div class="modal__section">
                    <h3 class="modal__subtitle">Regras de Peça Salvas</h3>
                    <div id="partRulesList" class="rules-list"></div>
                </div>
            </div>

            <!-- Seção de Funcionários -->
            <div id="config-view-funcionarios" class="config-view">
                <div class="modal__section" style="border-top: none; padding-top: 0; margin-top: 0;">
                    <h3 class="modal__subtitle">Novo Funcionário</h3>
                    <div class="form-grid" style="grid-template-columns: 1fr auto; align-items: end;">
                        <input type="text" id="funcionarioName" placeholder="Nome do Funcionário" class="form-input">
                        <button id="saveFuncionario" class="btn btn--success">Salvar</button>
                    </div>
                </div>
                <div class="modal__section">
                    <h3 class="modal__subtitle">Funcionários Cadastrados</h3>
                    <div id="funcionariosList" class="generic-list"></div>
                </div>
            </div>

            <!-- Seção de Serviços -->
            <div id="config-view-servicos" class="config-view">
                 <div class="modal__section" style="border-top: none; padding-top: 0; margin-top: 0;">
                    <h3 class="modal__subtitle">Novo Serviço</h3>
                    <div class="form-grid" style="grid-template-columns: 1fr auto; align-items: end;">
                        <input type="text" id="servicoName" placeholder="Nome do Serviço (Etapa)" class="form-input">
                        <button id="saveServico" class="btn btn--success">Salvar</button>
                    </div>
                </div>
                <div class="modal__section">
                    <h3 class="modal__subtitle">Serviços Cadastrados</h3>
                    <div id="servicosList" class="generic-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DE ANÁLISE -->
    <div id="analysisModal" class="modal">
        <div class="modal__content">
            <span class="modal__close" onclick="this.parentElement.parentElement.style.display='none'">&times;</span>
            <h2 class="modal__title">Resultado da Análise</h2>
            <div id="analysisResult" class="analysis-result"></div>
        </div>
    </div>

    <!-- MODAL DE ROMANEIO -->
    <div id="romaneioModal" class="modal">
        <div class="modal__content modal__content--large">
            <span class="modal__close" onclick="this.parentElement.parentElement.style.display='none'">&times;</span>
            <div id="romaneio-page" class="romaneio-page">
                <div id="romaneio-header"></div>
                <div id="romaneio-items"></div>
            </div>
            <div class="romaneio-footer">
                <!-- Botões são adicionados dinamicamente via JS -->
            </div>
        </div>
    </div>

    <!-- MODAL DE TRATAMENTO DE ITENS (NOVO LAYOUT) -->
    <div id="treatmentModal" class="modal">
        <div class="modal__content modal__content--xlarge">
            <span class="modal__close" onclick="this.parentElement.parentElement.style.display='none'">&times;</span>
            <div class="treatment-header">
                <h2 class="modal__title" id="treatment-client-name">Tratamento de Itens</h2>
                <p class="modal__subtitle">Análise detalhada e resumo quantitativo dos itens da planilha.</p>
            </div>
            <div class="treatment-layout">
                <div class="treatment-main-content">
                    <h3 class="section-title">Lista de Itens Processados</h3>
                    <div class="table-wrapper">
                        <table id="treatmentResultTable" class="data-table">
                              <thead>
                                  <tr>
                                      <th>TIPO</th><th>DESCRIÇÃO</th><th>COR</th><th>PRODUTO</th><th>CATEGORIA</th>
                                  </tr>
                              </thead>
                              <tbody></tbody>
                        </table>
                    </div>
                    
                    <div class="modal__section">
                        <h3 class="section-title">Acompanhamento de Serviços</h3>
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr auto; align-items: end; gap: 1rem; background-color: var(--color-bg); padding: 1rem; border-radius: 8px;">
                            <div>
                                <label for="servicoFuncionario" class="modal__subtitle" style="margin-bottom: 0.5rem; display: block;">Funcionário</label>
                                <select id="servicoFuncionario" class="form-select"></select>
                            </div>
                            <div>
                                <label for="servicoEtapa" class="modal__subtitle" style="margin-bottom: 0.5rem; display: block;">Etapa</label>
                                <select id="servicoEtapa" class="form-select"></select>
                            </div>
                            <div>
                                <label for="servicoData" class="modal__subtitle" style="margin-bottom: 0.5rem; display: block;">Data</label>
                                <input type="date" id="servicoData" class="form-input">
                            </div>
                            <button id="saveClientService" class="btn btn--success">Adicionar</button>
                        </div>
                    </div>
                    
                    <div class="modal__section">
                         <div id="client-service-log"></div>
                    </div>
                    
                </div>
                <div class="treatment-summary-sidebar">
                    <h3 class="section-title">Resumo Geral</h3>
                    <div id="total-geral-summary" class="summary-card">
                        <!-- Conteúdo injetado via JS -->
                    </div>
                    <div class="summary-card">
                        <h4 class="summary-card__title">Total por Produto</h4>
                        <div class="table-wrapper--condensed">
                            <table id="treatmentSummaryTableProduct" class="summary-table">
                                <thead><tr><th>PRODUTO</th><th>QTD</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="summary-card">
                        <h4 class="summary-card__title">Total por Categoria</h4>
                         <div class="table-wrapper--condensed">
                            <table id="treatmentSummaryTableCategory" class="summary-table">
                                <thead><tr><th>CATEGORIA</th><th>QTD</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        // --- CONFIGURAÇÃO FIREBASE ---
        const firebaseConfig = {"apiKey":"AIzaSyCB8ye34UIkBghExod4JlBV3oqge5oM2Ic","authDomain":"ferramentas-perfecta.firebaseapp.com","databaseURL":"https://ferramentas-perfecta-default-rtdb.firebaseio.com","projectId":"ferramentas-perfecta","storageBucket":"ferramentas-perfecta.appspot.com","messagingSenderId":"550722056346","appId":"1:550722056346:web:9e2e0948c58e15b5af6f23"};
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- VARIÁVEIS GLOBAIS ---
        let fullSpreadsheetData = [];
        let rulesRef;
        let rulesPartRef;
        let rules = [];
        let partRules = [];
        let currentClientId = null;

        // --- CONTROLE DE NAVEGAÇÃO E MODAIS ---
        const mainContainer = document.querySelector('.app-container');
        const clientsView = document.getElementById('clients-view');
        const romaneioChecklistView = document.getElementById('romaneio-checklist-view');
        const productionChecklistView = document.getElementById('production-checklist-view');
        const configModal = document.getElementById('configModal');
        const analysisModal = document.getElementById('analysisModal');
        const treatmentModal = document.getElementById('treatmentModal');

        function showMainView() {
            mainContainer.style.display = 'block';
            clientsView.style.display = 'none';
            romaneioChecklistView.style.display = 'none';
            productionChecklistView.style.display = 'none';
        }
        function showClientsView() {
            mainContainer.style.display = 'none';
            clientsView.style.display = 'block';
            romaneioChecklistView.style.display = 'none';
            productionChecklistView.style.display = 'none';
            loadClientsList();
        }
        
        function showConfigModal() {
            configModal.style.display = 'flex';
            showConfigView('regras');
            loadConfigForms('romaneio');
        }
        
        function showAnalysisModal() {
            analysisModal.style.display = 'flex';
            analyzeCurrentTable();
        }

        document.getElementById('configButton').onclick = showConfigModal;
        document.getElementById('accessClientsButton').onclick = showClientsView;
        document.getElementById('analyzeTableButton').onclick = showAnalysisModal;
        
        // --- LÓGICA DA TELA DE CONFIGURAÇÃO (FUNCIONAL E COMPLETA) ---
        function showConfigView(viewName) {
            document.querySelectorAll('.config-view').forEach(v => v.classList.remove('active'));
            document.getElementById(`config-view-${viewName}`).classList.add('active');
            if(viewName === 'funcionarios') loadGenericList('funcionario');
            if(viewName === 'servicos') loadGenericList('servico');
        }

        function loadConfigForms(mode) {
            const romaneioBtn = document.getElementById('config-mode-romaneio');
            const producaoBtn = document.getElementById('config-mode-producao');
            
            if (rulesRef) rulesRef.off();
            if (rulesPartRef) rulesPartRef.off();
            
            document.getElementById('rulesList').innerHTML = 'Carregando...';
            document.getElementById('partRulesList').innerHTML = 'Carregando...';

            if (mode === 'romaneio') {
                rulesRef = database.ref('dados/romaneio');
                rulesPartRef = database.ref('dados/romaneioPecas');
                romaneioBtn.style.backgroundColor = 'var(--color-accent-secondary)';
                producaoBtn.style.backgroundColor = 'var(--color-text-light)';
            } else {
                rulesRef = database.ref('dados/producao');
                rulesPartRef = database.ref('dados/producaoPecas');
                romaneioBtn.style.backgroundColor = 'var(--color-text-light)';
                producaoBtn.style.backgroundColor = 'var(--color-accent-secondary)';
            }
            attachFirebaseListeners();
        }
        document.getElementById('config-mode-romaneio').addEventListener('click', () => loadConfigForms('romaneio'));
        document.getElementById('config-mode-producao').addEventListener('click', () => loadConfigForms('producao'));

        function attachFirebaseListeners() {
            rulesRef.on('value', snapshot => {
                const data = snapshot.val();
                const listEl = document.getElementById('rulesList');
                listEl.innerHTML = '';
                rules = [];
                if (data) {
                    Object.entries(data).forEach(([key, rule]) => {
                        rules.push({ id: key, ...rule });
                        const ruleEl = document.createElement('div');
                        ruleEl.className = 'rule-item';
                        const checklistHTML = rule.checklist.map(item => `<li>${item.symbol || '■'} ${item.text}</li>`).join('');
                        ruleEl.innerHTML = `
                            <div class="rule-item__info">
                                <p class="rule-item__code">Código contém: "${rule.codigo}"</p>
                                <ul class="rule-item__checklist">${checklistHTML}</ul>
                            </div>
                            <div class="rule-item__actions">
                                <button onclick="editRule('${key}')" class="btn btn--secondary"><i data-feather="edit-2"></i></button>
                                <button onclick="deleteRule('${key}')" class="btn btn--danger"><i data-feather="trash-2"></i></button>
                            </div>`;
                        listEl.appendChild(ruleEl);
                    });
                } else {
                    listEl.innerHTML = '<p>Nenhuma regra de código cadastrada.</p>';
                }
                feather.replace();
            });
            rulesPartRef.on('value', snapshot => {
                const data = snapshot.val();
                const listEl = document.getElementById('partRulesList');
                listEl.innerHTML = '';
                partRules = [];
                if (data) {
                    Object.entries(data).forEach(([key, rule]) => {
                        partRules.push({ id: key, ...rule });
                        const ruleEl = document.createElement('div');
                        ruleEl.className = 'rule-item';
                        const checklistHTML = rule.checklist.map(item => `<li>${item.symbol || '■'} ${item.text} (x${item.quantity})</li>`).join('');
                        ruleEl.innerHTML = `
                             <div class="rule-item__info">
                                 <p class="rule-item__code">Código contém: "${rule.codigo}"</p>
                                 <ul class="rule-item__checklist">${checklistHTML}</ul>
                            </div>
                            <div class="rule-item__actions">
                                <button onclick="editPartRule('${key}')" class="btn btn--secondary"><i data-feather="edit-2"></i></button>
                                <button onclick="deletePartRule('${key}')" class="btn btn--danger"><i data-feather="trash-2"></i></button>
                            </div>`;
                        listEl.appendChild(ruleEl);
                    });
                } else {
                    listEl.innerHTML = '<p>Nenhuma regra de peça cadastrada.</p>';
                }
                feather.replace();
            });
        }
        
        function deleteRule(key) { if(confirm('Tem certeza?')) rulesRef.child(key).remove(); }
        function deletePartRule(key) { if(confirm('Tem certeza?')) rulesPartRef.child(key).remove(); }
        
        function editRule(key) {
            const ruleToEdit = rules.find(r => r.id === key);
            if(ruleToEdit) {
                document.getElementById('ruleId').value = ruleToEdit.id;
                document.getElementById('ruleCode').value = ruleToEdit.codigo;
                const container = document.getElementById('newChecklistContainer');
                container.innerHTML = '';
                ruleToEdit.checklist.forEach(item => addChecklistItemInput(container.id, item));
                document.getElementById('cancelEdit').style.display = 'inline-flex';
            }
        }
        function editPartRule(key) {
            const ruleToEdit = partRules.find(r => r.id === key);
            if(ruleToEdit) {
                document.getElementById('partRuleId').value = ruleToEdit.id;
                document.getElementById('partRuleCode').value = ruleToEdit.codigo;
                const container = document.getElementById('newPartChecklistContainer');
                container.innerHTML = '';
                ruleToEdit.checklist.forEach(item => addChecklistItemInput(container.id, item, 'part'));
                document.getElementById('cancelPartEdit').style.display = 'inline-flex';
            }
        }
        
        function saveRule() {
            const ruleId = document.getElementById('ruleId').value;
            const code = document.getElementById('ruleCode').value.trim();
            if (!code) { alert('Código é obrigatório.'); return; }
            const checklistItems = Array.from(document.querySelectorAll('#newChecklistContainer .checklist-item-wrapper')).map(w => ({
                text: w.querySelector('.new-checklist-item').value.trim(),
                symbol: w.querySelector('.checklist-item-symbol').value
            })).filter(item => item.text);
            const ruleData = { codigo: code, checklist: checklistItems };
            if (ruleId) { rulesRef.child(ruleId).update(ruleData); } else { rulesRef.push(ruleData); }
            resetRuleForm();
        }
        
        function savePartRule() {
            const ruleId = document.getElementById('partRuleId').value;
            const code = document.getElementById('partRuleCode').value.trim();
            if (!code) { alert('Código é obrigatório.'); return; }
            const checklistItems = Array.from(document.querySelectorAll('#newPartChecklistContainer .checklist-item-wrapper')).map(w => ({
                text: w.querySelector('.new-checklist-item').value.trim(),
                symbol: w.querySelector('.checklist-item-symbol').value,
                quantity: parseInt(w.querySelector('.checklist-item-quantity').value, 10) || 1
            })).filter(item => item.text);
            const ruleData = { codigo: code, checklist: checklistItems };
            if (ruleId) { rulesPartRef.child(ruleId).update(ruleData); } else { rulesPartRef.push(ruleData); }
            resetPartRuleForm();
        }
        
        function resetRuleForm() {
            document.getElementById('ruleId').value = '';
            document.getElementById('ruleCode').value = '';
            document.getElementById('newChecklistContainer').innerHTML = '';
            document.getElementById('cancelEdit').style.display = 'none';
        }
        function resetPartRuleForm() {
            document.getElementById('partRuleId').value = '';
            document.getElementById('partRuleCode').value = '';
            document.getElementById('newPartChecklistContainer').innerHTML = '';
            document.getElementById('cancelPartEdit').style.display = 'none';
        }

        const addChecklistItemInput = (containerId, itemData = {}, type = 'code') => {
            const container = document.getElementById(containerId);
            const wrapper = document.createElement('div');
            wrapper.className = 'checklist-item-wrapper';
            
            const handle = `<span class="drag-handle"><i data-feather="move" style="width:20px; height:20px; cursor: grab;"></i></span>`;
            const symbolSelect = `<select class="form-select checklist-item-symbol" style="width: 60px;"><option value="■">■</option><option value="▲">▲</option><option value="●">●</option><option value="*">*</option></select>`;
            const textInput = `<input type="text" placeholder="Item do checklist" class="new-checklist-item form-input" value="${itemData.text || ''}">`;
            let quantityInput = '';
            if (type === 'part') {
                quantityInput = `<input type="number" class="checklist-item-quantity form-input" value="${itemData.quantity || 1}" min="1" style="width: 80px;">`;
            }
            const deleteButton = `<button type="button" class="btn--icon btn--danger" onclick="this.parentElement.remove()"><i data-feather="x-circle" style="width:20px; height:20px;"></i></button>`;
            
            wrapper.innerHTML = handle + symbolSelect + textInput + quantityInput + deleteButton;
            if(itemData.symbol) wrapper.querySelector('.checklist-item-symbol').value = itemData.symbol;
            container.appendChild(wrapper);
            feather.replace();
        };
        
        document.getElementById('addChecklistItem').addEventListener('click', () => addChecklistItemInput('newChecklistContainer'));
        document.getElementById('addPartChecklistItem').addEventListener('click', () => addChecklistItemInput('newPartChecklistContainer', {}, 'part'));
        document.getElementById('saveRule').addEventListener('click', saveRule);
        document.getElementById('savePartRule').addEventListener('click', savePartRule);
        document.getElementById('cancelEdit').addEventListener('click', resetRuleForm);
        document.getElementById('cancelPartEdit').addEventListener('click', resetPartRuleForm);


        // --- LÓGICA DE PROCESSAMENTO DE PLANILHA ---
        document.getElementById('fileInput').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            document.getElementById('status').textContent = `Processando "${file.name}"...`;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    fullSpreadsheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                    drawInitialTable(fullSpreadsheetData);
                    document.getElementById('status').textContent = `Exibindo dados de "${file.name}".`;
                    document.getElementById('saveClientButton').style.display = 'inline-flex';
                } catch (error) {
                    console.error("Erro ao processar o arquivo:", error);
                    document.getElementById('status').textContent = 'Ocorreu um erro ao ler o arquivo.';
                }
            };
            reader.readAsBinaryString(file);
        });
        
        function drawInitialTable(jsonData) {
            const tableContainer = document.getElementById('table-container');
            const spreadsheetHeaderContainer = document.getElementById('spreadsheet-header-container');
            tableContainer.innerHTML = '';
            spreadsheetHeaderContainer.innerHTML = '';

            let tableHeaderRowIndex = jsonData.findIndex(row => Array.isArray(row) && row.some(cell => String(cell).toUpperCase().includes('CÓDIGO')));
            if(tableHeaderRowIndex === -1) {
                document.getElementById('status').textContent = 'Aviso: A coluna "Código" não foi encontrada na planilha.';
                return;
            }

            const headerContent = document.createElement('div');
            headerContent.className = 'spreadsheet-header__content';
            jsonData.slice(0, tableHeaderRowIndex).forEach(row => {
                const filteredCells = row.filter(cell => cell !== null && String(cell).trim() !== '');
                if (filteredCells.length > 0) {
                    const p = document.createElement('p');
                    p.className = 'spreadsheet-header__line';
                    if (String(filteredCells[0]).toLowerCase().includes('planilha de itens')) {
                        p.innerHTML = `<strong>${filteredCells.join(' ')}</strong>`;
                        p.classList.add('spreadsheet-header__line--title');
                    } else {
                        p.textContent = filteredCells.join(' \u00A0\u00A0\u00A0 ');
                    }
                    headerContent.appendChild(p);
                }
            });
            spreadsheetHeaderContainer.appendChild(headerContent);
            
            const header = jsonData[tableHeaderRowIndex];
            const tableData = jsonData.slice(tableHeaderRowIndex + 1);
            const table = document.createElement('table');
            table.className = "data-table";
            table.innerHTML = `<thead><tr>${header.map(h => `<th class="data-table__th">${h}</th>`).join('')}</tr></thead>
                                         <tbody>${tableData.map(rowData => `<tr>${rowData.map(cell => `<td class="data-table__td">${cell}</td>`).join('')}</tr>`).join('')}</tbody>`;
            tableContainer.appendChild(table);
        }

        function saveClient() {
            if (fullSpreadsheetData.length === 0) {
                alert('Nenhuma planilha carregada para salvar.');
                return;
            }

            const headerLinesElements = document.querySelectorAll('#spreadsheet-header-container .spreadsheet-header__line');
            let clientName = '';

            const headerTexts = Array.from(headerLinesElements).map(el => el.textContent.trim());
            const potentialNames = headerTexts.filter(text => {
                const isTitle = text.toLowerCase().includes('planilha de itens');
                const isOrderNumber = text.includes('N.º');
                const isDateTime = /^\d{2}\/\d{2}\/\d{4}/.test(text);
                return !isTitle && !isOrderNumber && !isDateTime;
            });

            if (potentialNames.length > 0) {
                clientName = potentialNames[0];
            } else {
                 clientName = prompt("Não foi possível identificar o nome. Por favor, digite o nome do cliente/obra:", `Cliente ${new Date().toLocaleDateString()}`);
            }
            
            if(!clientName) return;

            const clientData = { name: clientName, spreadsheetData: fullSpreadsheetData, createdAt: new Date().toISOString() };
            database.ref('dados/producao_clientes').push(clientData)
                .then(() => alert(`Cliente "${clientName}" salvo com sucesso!`))
                .catch(error => alert("Erro ao salvar."));
        }
        document.getElementById('saveClientButton').addEventListener('click', saveClient);

        // --- LÓGICA DA TELA DE CLIENTES ---
        function calculateTotalPieces(spreadsheetData) {
            if (!spreadsheetData || spreadsheetData.length === 0) {
                return 0;
            }
            let total = 0;
            const headerRowIndex = spreadsheetData.findIndex(row => Array.isArray(row) && row.some(cell => String(cell).toUpperCase().includes('CÓDIGO')));
            if (headerRowIndex === -1) return 0;

            const header = spreadsheetData[headerRowIndex];
            const qtdIndex = header.findIndex(h => String(h).toUpperCase().includes('QTD'));
            if (qtdIndex === -1) return 0;

            const dataRows = spreadsheetData.slice(headerRowIndex + 1);
            dataRows.forEach(row => {
                const qtyStr = row[qtdIndex] ? String(row[qtdIndex]).replace(",", ".") : '0';
                if (qtyStr.trim() !== '' && !isNaN(qtyStr)) {
                    total += parseFloat(qtyStr);
                }
            });
            return total;
        }

        function updateClientStatus(clientId, field, value) {
            const path = `dados/client_status/${clientId}/${field}`;
            database.ref(path).set(value);
        }

        function loadClientsList() {
            const listBody = document.getElementById('production-clients-list');
            listBody.innerHTML = '<tr><td colspan="5">Carregando...</td></tr>';
            const clientsRef = database.ref('dados/producao_clientes');
            
            clientsRef.on('value', snapshot => {
                listBody.innerHTML = '';
                const clients = snapshot.val();
                if (clients) {
                    Object.entries(clients).forEach(([clientId, client]) => {
                        const row = document.createElement('tr');
                        row.id = `client-row-${clientId}`;

                        const totalPieces = calculateTotalPieces(client.spreadsheetData);

                        row.innerHTML = `
                            <td class="data-table__td">${client.name}</td>
                            <td class="data-table__td">${totalPieces}</td>
                            <td class="data-table__td status-cell">Carregando...</td>
                            <td class="data-table__td stage-cell">Carregando...</td>
                            <td class="data-table__td">
                                <div style="display: flex; gap: 0.5rem; justify-content: flex-start;">
                                    <button class="btn btn--success" onclick="showItemTreatmentView('${clientId}')">Resumo</button>
                                    <button class="btn btn--success" style="background-color: #5a67d8;" onclick="generateDocument('${clientId}', 'producao')">Produção</button>
                                    <button class="btn btn--secondary" onclick="generateDocument('${clientId}', 'romaneio')">Romaneio</button>
                                </div>
                            </td>`;
                        listBody.appendChild(row);

                        const statusRef = database.ref(`dados/client_status/${clientId}`);
                        statusRef.on('value', statusSnapshot => {
                            const statusData = statusSnapshot.val() || {};
                            const currentStatus = statusData.andamento || 'Não iniciado';
                            const currentStage = statusData.etapa || 'Corte';

                            const statusCell = document.querySelector(`#client-row-${clientId} .status-cell`);
                            statusCell.innerHTML = `
                                <select class="form-select" onchange="updateClientStatus('${clientId}', 'andamento', this.value)">
                                    <option value="Não iniciado" ${currentStatus === 'Não iniciado' ? 'selected' : ''}>Não iniciado</option>
                                    <option value="Em andamento" ${currentStatus === 'Em andamento' ? 'selected' : ''}>Em andamento</option>
                                    <option value="Concluído" ${currentStatus === 'Concluído' ? 'selected' : ''}>Concluído</option>
                                </select>
                            `;

                            const stageCell = document.querySelector(`#client-row-${clientId} .stage-cell`);
                            stageCell.innerHTML = `
                                <select class="form-select" onchange="updateClientStatus('${clientId}', 'etapa', this.value)">
                                    <option value="Corte" ${currentStage === 'Corte' ? 'selected' : ''}>Corte</option>
                                    <option value="Usinagem" ${currentStage === 'Usinagem' ? 'selected' : ''}>Usinagem</option>
                                    <option value="Solda" ${currentStage === 'Solda' ? 'selected' : ''}>Solda</option>
                                    <option value="Montagem" ${currentStage === 'Montagem' ? 'selected' : ''}>Montagem</option>
                                    <option value="Conferência" ${currentStage === 'Conferência' ? 'selected' : ''}>Conferência</option>
                                </select>
                            `;
                        });
                    });
                } else {
                    listBody.innerHTML = '<tr><td colspan="5">Nenhum cliente em produção.</td></tr>';
                }
                feather.replace();
            });
        }
        
        // --- LÓGICA DE GERAÇÃO DE DOCUMENTOS ---
        async function generateDocument(clientId, mode) {
            try {
                const clientSnapshot = await database.ref(`dados/producao_clientes/${clientId}`).once('value');
                const clientData = clientSnapshot.val();
                if (!clientData || !clientData.spreadsheetData) { alert('Erro: Dados do cliente não encontrados.'); return; }

                const rulesPath = (mode === 'producao') ? 'dados/producao' : 'dados/romaneio';
                const partRulesPath = (mode === 'producao') ? 'dados/producaoPecas' : 'dados/romaneioPecas';

                const [rulesSnapshot, partRulesSnapshot] = await Promise.all([
                    database.ref(rulesPath).once('value'),
                    database.ref(partRulesPath).once('value')
                ]);
                
                const loadedRules = [];
                const rulesData = rulesSnapshot.val();
                if(rulesData) Object.entries(rulesData).forEach(([id, data]) => loadedRules.push({id, ...data}));

                const loadedPartRules = [];
                const partRulesData = partRulesSnapshot.val();
                if(partRulesData) Object.entries(partRulesData).forEach(([id, data]) => loadedPartRules.push({id, ...data}));

                await renderDocument(clientId, clientData.spreadsheetData, loadedRules, loadedPartRules, mode);
            } catch (error) {
                console.error("Erro ao gerar documento:", error);
                alert("Ocorreu um erro ao gerar o documento.");
            }
        }

        async function renderDocument(clientId, spreadsheetData, documentRules, documentPartRules, mode) {
            const romaneioHeaderContainer = document.getElementById('romaneio-header');
            const romaneioItemsContainer = document.getElementById('romaneio-items');
            romaneioHeaderContainer.innerHTML = '';
            romaneioItemsContainer.innerHTML = '';
            
            const statusSnapshot = await database.ref(`dados/${mode}_checklist_status/${clientId}`).once('value');
            const statuses = statusSnapshot.val() || {};

            const tableHeaderRowIndex = spreadsheetData.findIndex(row => Array.isArray(row) && row.some(cell => String(cell).toUpperCase().includes('CÓDIGO')));
            if (tableHeaderRowIndex === -1) { alert("Cabeçalho 'CÓDIGO' não encontrado na planilha salva."); return; }
            
            const tableHeader = spreadsheetData[tableHeaderRowIndex];
            const codeColumnIndex = tableHeader.findIndex(h => String(h).toUpperCase().includes('CÓDIGO'));
            const descColumnIndex = tableHeader.findIndex(h => String(h).toUpperCase().includes('DESCRIÇÃO'));
            const tipoColumnIndex = tableHeader.findIndex(h => String(h).toUpperCase() === 'TIPO');

            const title = mode === 'producao' ? 'Relatório de Produção' : 'Romaneio de Conferência';
            const checklistTitle = mode === 'producao' ? 'Checklist de Produção' : 'Checklist de Conferência';

            const spreadsheetHeaderData = spreadsheetData.slice(0, tableHeaderRowIndex);
            spreadsheetHeaderData.forEach(row => {
                const filteredCells = row.filter(cell => cell !== null && String(cell).trim() !== '');
                if (filteredCells.length > 0) {
                    const p = document.createElement('p');
                    if (String(filteredCells[0]).toLowerCase().includes('planilha de itens')) {
                        p.innerHTML = `<strong>${title}</strong>`;
                    } else {
                        p.innerHTML = filteredCells.map(cell => `<span>${cell}</span>`).join('<span style="margin: 0 1rem;">|</span>');
                    }
                    romaneioHeaderContainer.appendChild(p);
                }
            });

            const tableData = spreadsheetData.slice(tableHeaderRowIndex + 1);
            tableData.forEach((rowData, index) => {
                const itemCode = String(rowData[codeColumnIndex] || '').trim().toUpperCase();
                if (!itemCode) return;

                const itemDesc = descColumnIndex !== -1 ? String(rowData[descColumnIndex] || '') : 'Sem descrição';
                const itemTipo = tipoColumnIndex !== -1 ? String(rowData[tipoColumnIndex] || '') : '';
                const itemPos = String(rowData[0] || index + 1);

                let combinedChecklist = [];
                documentPartRules.filter(r => itemCode.includes(r.codigo.toUpperCase())).forEach(r => r.checklist.forEach(i => combinedChecklist.push(i)));
                documentRules.filter(r => itemCode.includes(r.codigo.toUpperCase())).forEach(r => r.checklist.forEach(i => combinedChecklist.push({ ...i, quantity: 1 })));

                let checklistHTML = `<h4 class="romaneio-item__checklist-title">${checklistTitle}</h4>`;
                if (combinedChecklist.length > 0) {
                    combinedChecklist.forEach((checkItem, checkItemIndex) => {
                        let boxesHTML = '';
                        for (let i = 0; i < (checkItem.quantity || 1); i++) {
                            const isChecked = statuses[itemPos]?.[checkItemIndex]?.[i] === true;
                            boxesHTML += `<div class="romaneio-item__checkbox-box">${isChecked ? '✔' : ''}</div>`;
                        }
                        checklistHTML += `
                            <div class="romaneio-item__checklist-item">
                                <div><span class="romaneio-item__symbol">${checkItem.symbol || '■'}</span><span>${checkItem.text}</span></div>
                                <div class="romaneio-item__checkbox-group">${boxesHTML}</div>
                            </div>`;
                    });
                } else {
                    checklistHTML += '<p style="font-size: 0.9rem; color: var(--color-text-light);">Nenhum checklist para este item.</p>';
                }

                const imageMapping = { PCR: 'pcr.png', JCR: 'jcr.png', PGR: 'pgr.png', FIX: 'fix.png', ABT: 'abt.png', IPC: 'ipc.png', IJC: 'ijc.png', PIV: 'piv.png', MAX: 'max.png' };
                let imageHTML = '';
                for (const key in imageMapping) {
                    if (itemCode.includes(key)) {
                        imageHTML = `<img src="${imageMapping[key]}" class="romaneio-item__image" alt="${key}">`;
                        break;
                    }
                }
                
                const itemCard = document.createElement('div');
                itemCard.className = 'romaneio-item';
                itemCard.innerHTML = `
                    <div class="romaneio-item__info">
                        <p class="romaneio-item__pos">Pos. ${itemPos}</p>
                        <p class="romaneio-item__code">${itemCode}</p>
                        <p class="romaneio-item__desc">${itemDesc}</p>
                        ${itemTipo ? `<p class="romaneio-item__tipo">${itemTipo}</p>` : ''}
                        ${imageHTML}
                    </div>
                    <div class="romaneio-item__checklist">${checklistHTML}</div>`;
                romaneioItemsContainer.appendChild(itemCard);
            });
            
            const observationNotes = document.getElementById('observation-notes');
            if (observationNotes && observationNotes.value.trim() !== '') {
                const observationSection = document.createElement('div');
                observationSection.className = 'romaneio-observations';
                observationSection.innerHTML = `
                    <h4 class="romaneio-item__checklist-title">Observações</h4>
                    <p style="white-space: pre-wrap;">${observationNotes.value}</p>
                `;
                romaneioItemsContainer.appendChild(observationSection);
            }

            const signatureSection = document.createElement('div');
            signatureSection.className = 'romaneio-signatures';
            signatureSection.innerHTML = `<div class="signature-line"><div></div><p>Assinatura Conferente</p></div><div class="signature-line"><div></div><p>Assinatura do Supervisor</p></div>`;
            romaneioItemsContainer.appendChild(signatureSection);
            
            const romaneioFooter = document.querySelector('#romaneioModal .romaneio-footer');
            let footerHTML = `<button onclick="window.print()" class="btn btn--primary" style="flex-grow: 0;"><i data-feather="printer"></i><span>Imprimir</span></button>`;
            if (mode === 'romaneio') {
                footerHTML += `<button onclick="openChecklistInNewTab('${clientId}')" class="btn btn--success" style="flex-grow: 0;"><i data-feather="check-square"></i><span>Checklist Online</span></button>`;
            } else if (mode === 'producao') {
                 footerHTML += `<button onclick="openProductionChecklistInNewTab('${clientId}')" class="btn btn--success" style="flex-grow: 0;"><i data-feather="check-square"></i><span>Checklist Online</span></button>`;
            }
            romaneioFooter.innerHTML = footerHTML;
            feather.replace();

            document.getElementById('romaneioModal').style.display = 'flex';
        }
        
        // --- LÓGICA DE TRATAMENTO DE ITENS (REMODELADA) ---
        function getCodigo(texto) {
            const str = texto.toLowerCase();
            if (str.includes("fixo")) return "Fixo";
            if (str.includes("porta de correr") && str.includes("persiana")) return "PCR Integrada";
            if (str.includes("janela de correr") && str.includes("persiana")) return "JCR Integrada";
            if (str.includes("porta de correr")) return "PCR";
            if (str.includes("janela de correr")) return "JCR";
            if (str.includes("persiana")) return "Integrada";
            if (str.includes("acm")) return "ACM";
            if (str.includes("maxim-ar") || str.includes("maxim") || str.includes("max")) return "Maxim-ar";
            if (str.includes("porta de giro")) return "PGR";
            if (str.includes("oscilo") || str.includes("osc") || str.includes("abt")) return "Oscilo";
            if (str.includes("pivotante")) return "Pivotante";
            if (str.includes("brise")) return "Brise";
            if (str.includes("ripado")) return "Ripado";
            return "";
        }

        function getCodigo2(texto) {
            const str = texto.toLowerCase();
            if (str.includes("gol")) return "Aluminio";
            if (str.includes("rip")) return "Ripado";
            if (str.includes("brise")) return "Brise";
            if (str.includes("acm") || str.includes("layer")) return "Layer";
            return "PVC";
        }

        async function showItemTreatmentView(clientId) {
            currentClientId = clientId;
            const clientSnapshot = await database.ref(`dados/producao_clientes/${clientId}`).once('value');
            const clientData = clientSnapshot.val();
            if (!clientData || !clientData.spreadsheetData) {
                alert('Erro: Dados do cliente não encontrados.');
                return;
            }
            
            document.getElementById('treatment-client-name').textContent = `Resumo do Cliente: ${clientData.name}`;

            const data = clientData.spreadsheetData;
            let processedData = [];
            const summaryCounts = {};
            const summaryCounts2 = {};
            let totalItens = 0;

            const headerRowIndex = data.findIndex(row => Array.isArray(row) && row.some(cell => String(cell).toUpperCase().includes('CÓDIGO')));
            if(headerRowIndex === -1) { alert("Cabeçalho 'CÓDIGO' não encontrado na planilha do cliente."); return; }
            const header = data[headerRowIndex];
            const dataRows = data.slice(headerRowIndex + 1);
            
            const tipoIndex = header.findIndex(h => String(h).toUpperCase().includes('TIPO'));
            const descIndex = header.findIndex(h => String(h).toUpperCase().includes('DESCRIÇÃO'));
            const corIndex = header.findIndex(h => String(h).toUpperCase().includes('COR'));
            const qtdIndex = header.findIndex(h => String(h).toUpperCase().includes('QTD'));
            const itensIndex = header.findIndex(h => String(h).toUpperCase().includes('ITENS'));


            dataRows.forEach(row => {
                const quantidadeStr = qtdIndex !== -1 ? String(row[qtdIndex]).replace(",", ".") : '0';
                if (row.length > 1 && quantidadeStr.trim() !== '' && !isNaN(quantidadeStr)) {
                    const tipo = tipoIndex !== -1 ? row[tipoIndex] : '';
                    const descricao = descIndex !== -1 ? row[descIndex] : '';
                    const cor = corIndex !== -1 ? row[corIndex] : '';
                    const itens = itensIndex !== -1 ? row[itensIndex] : '';
                    const produto = getCodigo(descricao);
                    const categoria = getCodigo2(itens);
                    const quantidade = parseFloat(quantidadeStr);
                    
                    processedData.push({tipo, descricao, cor, produto, categoria});

                    if (produto) {
                        summaryCounts[produto] = (summaryCounts[produto] || 0) + quantidade;
                    }
                    summaryCounts2[categoria] = (summaryCounts2[categoria] || 0) + quantidade;
                    totalItens += quantidade;
                }
            });

            const resultTbody = document.querySelector('#treatmentResultTable tbody');
            resultTbody.innerHTML = '';
            processedData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${row.tipo || ''}</td>
                                <td>${row.descricao || ''}</td>
                                <td>${row.cor || ''}</td>
                                <td>${row.produto || ''}</td>
                                <td>${row.categoria || ''}</td>`;
                resultTbody.appendChild(tr);
            });

            const totalGeralContainer = document.getElementById('total-geral-summary');
            totalGeralContainer.innerHTML = `
                <div class="total-label">Total Geral de Itens</div>
                <div class="total-value">${totalItens}</div>
            `;

            const summaryTbodyProduct = document.querySelector('#treatmentSummaryTableProduct tbody');
            summaryTbodyProduct.innerHTML = '';
            Object.entries(summaryCounts).forEach(([item, qtd]) => {
                summaryTbodyProduct.innerHTML += `<tr><td>${item}</td><td>${qtd}</td></tr>`;
            });

            const summaryTbodyCategory = document.querySelector('#treatmentSummaryTableCategory tbody');
            summaryTbodyCategory.innerHTML = '';
            Object.entries(summaryCounts2).forEach(([item, qtd]) => {
                summaryTbodyCategory.innerHTML += `<tr><td>${item}</td><td>${qtd}</td></tr>`;
            });
            
            await populateDropdown('funcionarios', 'servicoFuncionario');
            await populateDropdown('servicos', 'servicoEtapa');
            document.getElementById('servicoData').valueAsDate = new Date();
            renderClientServices(clientId);


            treatmentModal.style.display = 'flex';
        }

        // --- NOVAS FUNÇÕES PARA CHECKLISTS ONLINE ---
        function openChecklistInNewTab(clientId) {
            document.getElementById('romaneioModal').style.display = 'none';
            const checklistUrl = `${window.location.href.split('#')[0]}#romaneio-checklist=${clientId}`;
            window.open(checklistUrl, '_blank');
        }

        function openProductionChecklistInNewTab(clientId) {
            document.getElementById('romaneioModal').style.display = 'none';
            const checklistUrl = `${window.location.href.split('#')[0]}#production-checklist=${clientId}`;
            window.open(checklistUrl, '_blank');
        }

        function shareRomaneioChecklistLink(clientId) {
            const shareUrl = `${window.location.href.split('#')[0]}#romaneio-checklist=${clientId}`;
            navigator.clipboard.writeText(shareUrl).then(() => alert('Link do checklist de romaneio copiado!'));
        }

        function shareProductionChecklistLink(clientId) {
            const shareUrl = `${window.location.href.split('#')[0]}#production-checklist=${clientId}`;
            navigator.clipboard.writeText(shareUrl).then(() => alert('Link do checklist de produção copiado!'));
        }

        function updateProducaoChecklistStatus(clientId, itemPos, checkItemIndex, checkIndex, isChecked) {
            const path = `dados/producao_checklist_status/${clientId}/${itemPos}/${checkItemIndex}/${checkIndex}`;
            database.ref(path).set(isChecked);
        }

        function updateRomaneioChecklistStatus(clientId, itemPos, checkItemIndex, checkIndex, isChecked) {
            const path = `dados/romaneio_checklist_status/${clientId}/${itemPos}/${checkItemIndex}/${checkIndex}`;
            database.ref(path).set(isChecked);
        }

        async function showChecklistView(mode, clientId) {
            const viewEl = mode === 'producao' ? productionChecklistView : romaneioChecklistView;
            const otherViews = [mainContainer, clientsView, (mode === 'producao' ? romaneioChecklistView : productionChecklistView)];
            
            otherViews.forEach(v => v.style.display = 'none');
            viewEl.style.display = 'block';
            viewEl.innerHTML = `<div class="view__content"><h2>Carregando checklist de ${mode}...</h2></div>`;

            try {
                const [clientSnapshot, rulesSnapshot, partRulesSnapshot] = await Promise.all([
                    database.ref(`dados/producao_clientes/${clientId}`).once('value'),
                    database.ref(`dados/${mode}`).once('value'),
                    database.ref(`dados/${mode}Pecas`).once('value')
                ]);

                const clientData = clientSnapshot.val();
                if (!clientData) {
                    viewEl.innerHTML = '<div class="view__content"><h2>Erro: Cliente não encontrado.</h2></div>';
                    return;
                }

                const rules = [];
                if (rulesSnapshot.val()) Object.entries(rulesSnapshot.val()).forEach(([id, data]) => rules.push({ id, ...data }));
                
                const partRules = [];
                if (partRulesSnapshot.val()) Object.entries(partRulesSnapshot.val()).forEach(([id, data]) => partRules.push({ id, ...data }));

                const title = mode === 'producao' ? 'Produção' : 'Romaneio';
                const functionNamePrefix = mode === 'producao' ? 'Producao' : 'Romaneio';
                const shareFunctionName = mode === 'producao' ? 'shareProductionChecklistLink' : 'shareRomaneioChecklistLink';


                let contentHTML = `
                    <div class="view__content view__content--large">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                            <h2 class="view__title" style="margin-bottom: 0;">Checklist ${title}: ${clientData.name}</h2>
                            <button class="btn btn--warning" style="flex-grow: 0;" onclick="${shareFunctionName}('${clientId}')"><i data-feather="share-2"></i> <span>Copiar Link</span></button>
                        </div>
                    </div>`;

                const tableHeaderRowIndex = clientData.spreadsheetData.findIndex(row => Array.isArray(row) && row.some(cell => String(cell).toUpperCase().includes('CÓDIGO')));
                const tableHeader = clientData.spreadsheetData[tableHeaderRowIndex];
                const codeColumnIndex = tableHeader.findIndex(h => String(h).toUpperCase().includes('CÓDIGO'));
                const descColumnIndex = tableHeader.findIndex(h => String(h).toUpperCase().includes('DESCRIÇÃO'));
                const tipoColumnIndex = tableHeader.findIndex(h => String(h).toUpperCase() === 'TIPO');
                
                const tableData = clientData.spreadsheetData.slice(tableHeaderRowIndex + 1);
                tableData.forEach((rowData, index) => {
                    const itemCode = String(rowData[codeColumnIndex] || '').trim().toUpperCase();
                    if (!itemCode) return;

                    const itemPos = String(rowData[0] || index + 1);
                    const itemDesc = descColumnIndex !== -1 ? String(rowData[descColumnIndex] || '') : 'Sem descrição';
                    const itemTipo = tipoColumnIndex !== -1 ? String(rowData[tipoColumnIndex] || '') : '';

                    let combinedChecklist = [];
                    partRules.filter(r => itemCode.includes(r.codigo.toUpperCase()) && Array.isArray(r.checklist)).forEach(r => r.checklist.forEach(i => { if (i && i.text) combinedChecklist.push(i); }));
                    rules.filter(r => itemCode.includes(r.codigo.toUpperCase()) && Array.isArray(r.checklist)).forEach(r => r.checklist.forEach(i => { if (i && i.text) combinedChecklist.push({ ...i, quantity: 1 }); }));

                    if (combinedChecklist.length > 0) {
                        let checklistHTML = `<h4 class="romaneio-item__checklist-title">Checklist de ${title}</h4>`;
                        combinedChecklist.forEach((checkItem, checkItemIndex) => {
                            if (checkItem && checkItem.text) {
                                let boxesHTML = '';
                                for (let i = 0; i < (checkItem.quantity || 1); i++) {
                                    const checkId = `${mode}-check-${clientId}-${itemPos}-${checkItemIndex}-${i}`;
                                    boxesHTML += `<input type="checkbox" id="${checkId}" onchange="update${functionNamePrefix}ChecklistStatus('${clientId}', '${itemPos}', '${checkItemIndex}', ${i}, this.checked)">`;
                                }
                                checklistHTML += `
                                    <div class="romaneio-item__checklist-item">
                                        <div><span class="romaneio-item__symbol">${checkItem.symbol || '■'}</span><span>${checkItem.text}</span></div>
                                        <div class="romaneio-item__checkbox-group">${boxesHTML}</div>
                                    </div>`;
                            }
                        });

                        const imageMapping = { PCR: 'pcr.png', JCR: 'jcr.png', PGR: 'pgr.png', FIX: 'fix.png', ABT: 'abt.png', IPC: 'ipc.png', IJC: 'ijc.png', PIV: 'piv.png', MAX: 'max.png' };
                        let imageHTML = '';
                        for (const key in imageMapping) {
                            if (itemCode.includes(key)) {
                                imageHTML = `<img src="${imageMapping[key]}" class="romaneio-item__image" alt="${key}">`;
                                break;
                            }
                        }
                        
                        contentHTML += `
                            <div class="romaneio-item view__content view__content--large checklist-page" style="margin-top: 1rem; padding-top: 1rem;">
                                <div class="romaneio-item__info">
                                    ${imageHTML}
                                    <div>
                                        <p class="romaneio-item__pos">Pos. ${itemPos}</p>
                                        <p class="romaneio-item__code">${itemCode}</p>
                                        <p class="romaneio-item__desc">${itemDesc}</p>
                                        ${itemTipo ? `<p class="romaneio-item__tipo">${itemTipo}</p>` : ''}
                                    </div>
                                </div>
                                <div class="romaneio-item__checklist">${checklistHTML}</div>
                            </div>`;
                    }
                });
                viewEl.innerHTML = contentHTML;
                feather.replace();
                
                database.ref(`dados/${mode}_checklist_status/${clientId}`).on('value', statusSnapshot => {
                    const statuses = statusSnapshot.val();
                    if(statuses) {
                        Object.entries(statuses).forEach(([itemPos, itemStatuses]) => {
                            Object.entries(itemStatuses).forEach(([checkItemIndex, checkStatuses]) => {
                                Object.entries(checkStatuses).forEach(([checkIndex, isChecked]) => {
                                    const checkId = `${mode}-check-${clientId}-${itemPos}-${checkItemIndex}-${checkIndex}`;
                                    const checkbox = document.getElementById(checkId);
                                    if (checkbox && checkbox.checked !== isChecked) {
                                        checkbox.checked = isChecked;
                                    }
                                });
                            });
                        });
                    }
                });
            } catch (error) {
                console.error(`Erro ao carregar checklist de ${mode}:`, error);
                viewEl.innerHTML = `<div class="view__content"><h2>Ocorreu um erro ao carregar o checklist.</h2></div>`;
            }
        }

        const showRomaneioChecklistView = (clientId) => showChecklistView('romaneio', clientId);
        const showProductionChecklistView = (clientId) => showChecklistView('producao', clientId);

        // --- LÓGICA PARA FUNCIONÁRIOS E SERVIÇOS ---
        function saveGenericItem(type) {
            const nameInput = document.getElementById(`${type}Name`);
            const name = nameInput.value.trim();
            if (!name) {
                alert('O nome não pode estar vazio.');
                return;
            }
            database.ref(`dados/${type}s`).push({ name: name });
            nameInput.value = '';
        }

        function deleteGenericItem(type, id) {
            if (confirm('Tem certeza que deseja excluir?')) {
                database.ref(`dados/${type}s/${id}`).remove();
            }
        }

        function loadGenericList(type) {
            const listEl = document.getElementById(`${type}sList`);
            const ref = database.ref(`dados/${type}s`);
            ref.on('value', snapshot => {
                listEl.innerHTML = '';
                const data = snapshot.val();
                if (data) {
                    Object.entries(data).forEach(([key, item]) => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'generic-list-item';
                        itemEl.innerHTML = `
                            <div class="generic-list-item__info">${item.name}</div>
                            <div class="generic-list-item__actions">
                                <button onclick="deleteGenericItem('${type}', '${key}')" class="btn btn--icon btn--danger"><i data-feather="trash-2"></i></button>
                            </div>
                        `;
                        listEl.appendChild(itemEl);
                    });
                } else {
                    listEl.innerHTML = `<p>Nenhum item cadastrado.</p>`;
                }
                feather.replace();
            });
        }
        
        async function populateDropdown(type, elementId) {
            const selectEl = document.getElementById(elementId);
            selectEl.innerHTML = '<option>Carregando...</option>';
            const snapshot = await database.ref(`dados/${type}s`).once('value');
            const data = snapshot.val();
            selectEl.innerHTML = '';
            if (data) {
                Object.entries(data).forEach(([key, item]) => {
                    selectEl.innerHTML += `<option value="${item.name}">${item.name}</option>`;
                });
            } else {
                selectEl.innerHTML = `<option>Nenhum item cadastrado</option>`;
            }
        }
        
        document.getElementById('saveFuncionario').addEventListener('click', () => saveGenericItem('funcionario'));
        document.getElementById('saveServico').addEventListener('click', () => saveGenericItem('servico'));

        // --- LÓGICA DE ACOMPANHAMENTO DE SERVIÇOS DO CLIENTE ---
        document.getElementById('saveClientService').addEventListener('click', () => {
            if (!currentClientId) return;
            const funcionario = document.getElementById('servicoFuncionario').value;
            const etapa = document.getElementById('servicoEtapa').value;
            const data = document.getElementById('servicoData').value;

            if (!funcionario || !etapa || !data) {
                alert('Por favor, preencha todos os campos.');
                return;
            }
            
            const serviceLog = { funcionario, etapa, data };
            database.ref(`dados/client_services/${currentClientId}`).push(serviceLog);
        });
        
        function renderClientServices(clientId) {
            const container = document.getElementById('client-service-log');
            const ref = database.ref(`dados/client_services/${clientId}`);
            ref.on('value', snapshot => {
                container.innerHTML = '<h4>Serviços Realizados</h4>';
                const data = snapshot.val();
                if (data) {
                    const table = document.createElement('table');
                    table.className = 'data-table';
                    table.innerHTML = `<thead><tr><th>Data</th><th>Funcionário</th><th>Etapa</th></tr></thead><tbody></tbody>`;
                    const tbody = table.querySelector('tbody');
                    Object.values(data).sort((a,b) => new Date(b.data) - new Date(a.data)).forEach(log => {
                        tbody.innerHTML += `<tr><td>${new Date(log.data + 'T00:00:00').toLocaleDateString()}</td><td>${log.funcionario}</td><td>${log.etapa}</td></tr>`;
                    });
                    container.appendChild(table);
                } else {
                    container.innerHTML += '<p>Nenhum serviço registrado para este cliente.</p>';
                }
            });
        }


        // --- INICIALIZAÇÃO ---
        window.addEventListener('load', () => {
            document.querySelectorAll('.app-container, .view').forEach(el => el.style.display = 'none');

            const hash = window.location.hash;
            const romaneioPrefix = '#romaneio-checklist=';
            const productionPrefix = '#production-checklist=';

            if (hash.startsWith(romaneioPrefix)) {
                const clientId = hash.substring(romaneioPrefix.length);
                if (clientId) showRomaneioChecklistView(clientId);
            } else if (hash.startsWith(productionPrefix)) {
                const clientId = hash.substring(productionPrefix.length);
                if (clientId) showProductionChecklistView(clientId);
            }
            else {
                 showMainView();
            }
        });
        feather.replace();
    </script>
</body>
</html>
