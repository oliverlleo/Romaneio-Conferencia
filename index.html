<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor de Planilha com Regras | Flat Design</title>

    <!-- SDKs do Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <!-- Biblioteca SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Fontes e Ícones -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        /* --- ARQUITETURA FLAT DESIGN 2.0 --- */
        :root {
            --font-family-sans: 'Montserrat', sans-serif;
            --color-text: #1E293B;
            --color-text-light: #64748B;
            --color-bg: #F1F5F9;
            --color-panel-bg: #FFFFFF;
            --color-border: #E2E8F0;
            --color-accent-primary: #0D9488;
            --color-accent-primary-hover: #0F766E;
            --color-accent-secondary: #475569;
            --color-accent-secondary-hover: #334155;
            --color-success: #16A34A;
            --color-success-hover: #15803D;
            --color-danger: #DC2626;
            --color-danger-hover: #B91C1C;
            --color-warning: #D97706;
            --color-warning-hover: #B45309;
        }

        /* --- Mode Switch Component --- */
        .mode-switch {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background-color: var(--color-bg);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--color-text-light);
            flex-grow: 1;
            justify-content: center;
        }
        .mode-switch .label-producao {
            color: var(--color-text);
        }
        .mode-switch .label-romaneio {
            color: var(--color-text);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--color-accent-secondary);
            transition: .4s;
            border-radius: 28px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--color-accent-primary);
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }

        /* --- Production Views --- */
        .production-view {
            display: none; /* Oculto por padrão */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-bg);
            z-index: 2000;
            padding: 2rem;
            overflow-y: auto;
        }
        .production-view__title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 2rem;
            color: var(--color-text);
        }

        /* Estilos para a tabela do dashboard */
        #production-dashboard-view .table-wrapper {
            max-width: 900px;
            margin: 0 auto;
            background-color: var(--color-panel-bg);
        }

        /* Estilos para o checklist interativo */
        .interactive-checklist-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            background-color: #fff;
            border: 1px solid var(--color-border);
        }
        .interactive-checklist-item label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            font-size: 1rem;
        }
        .interactive-checklist-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* --- Reset e Base --- */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
        }

        body {
            font-family: var(--font-family-sans);
            background-color: var(--color-bg);
            color: var(--color-text);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* --- Layout Principal --- */
        .app-container {
            width: 100%;
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: var(--color-panel-bg);
        }

        .app-header {
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 2rem;
            color: var(--color-text);
        }

        .action-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .status-text {
            text-align: center;
            margin: 2rem 0;
            color: var(--color-text-light);
        }

        /* --- Botões --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            font-family: var(--font-family-sans);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
            text-decoration: none;
            flex-grow: 1;
        }

        .btn i {
            width: 18px;
            height: 18px;
        }

        .btn--primary {
            background-color: var(--color-accent-primary);
            color: white;
        }
        .btn--primary:hover {
            background-color: var(--color-accent-primary-hover);
        }

        .btn--secondary {
            background-color: var(--color-accent-secondary);
            color: white;
        }
        .btn--secondary:hover {
            background-color: var(--color-accent-secondary-hover);
        }

        .btn--success {
            background-color: var(--color-success);
            color: white;
        }
        .btn--success:hover {
            background-color: var(--color-success-hover);
        }

        .btn--danger {
            background-color: var(--color-danger);
            color: white;
        }
        .btn--danger:hover {
            background-color: var(--color-danger-hover);
        }

        .btn--warning {
            background-color: var(--color-warning);
            color: white;
        }
        .btn--warning:hover {
            background-color: var(--color-warning-hover);
        }

        .btn--text {
            background-color: transparent;
            color: var(--color-accent-primary);
            padding: 0.25rem;
            justify-content: flex-start;
        }
        .btn--text:hover {
            color: var(--color-accent-primary-hover);
        }

        .btn--icon {
            background: transparent;
            border: none;
            padding: 0.25rem;
            cursor: pointer;
            line-height: 1;
        }
        .btn--icon:hover {
            color: var(--color-danger);
        }

        .file-input {
            display: none;
        }

        /* --- Modais --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(30, 41, 59, 0.8);
            align-items: center;
            justify-content: center;
        }

        .modal__content {
            background-color: var(--color-panel-bg);
            padding: 2.5rem;
            width: 90%;
            max-width: 700px;
            position: relative;
            animation: fadeIn 0.3s;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal__content--large {
            max-width: 1100px;
        }

        .modal__close {
            color: var(--color-text-light);
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        .modal__close:hover {
            color: var(--color-text);
        }

        .modal__title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 2rem;
        }

        .modal__section {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--color-border);
        }

        .modal__subtitle {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--color-accent-secondary);
        }

        /* --- Formulários --- */
        .form-grid {
            display: grid;
            gap: 1rem;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 0.75rem;
            font-family: var(--font-family-sans);
            font-size: 1rem;
            background-color: var(--color-bg);
            border: 1px solid var(--color-border);
            color: var(--color-text);
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: 2px solid var(--color-accent-primary);
            border-color: var(--color-accent-primary);
        }

        .checklist-item-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .drag-handle {
            cursor: grab;
            color: var(--color-text-light);
        }
        .checklist-item-wrapper.dragging {
            opacity: 0.5;
            background: var(--color-border);
        }

        /* --- Tabela --- */
        .spreadsheet-header {
            margin-bottom: 1.5rem;
        }
        .spreadsheet-header__content {
            background-color: var(--color-bg);
            padding: 1.5rem;
        }
        .spreadsheet-header__line {
            margin-bottom: 0.5rem;
        }
        .spreadsheet-header__line--title {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            border: 1px solid var(--color-border);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table__th, .data-table__td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--color-border);
            white-space: nowrap;
        }

        .data-table__th {
            background-color: var(--color-bg);
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--color-text-light);
        }

        .data-table__tfoot {
            background-color: var(--color-bg);
        }

        /* --- Componentes Específicos --- */
        .rules-list {
            display: grid;
            gap: 1rem;
        }
        .rule-item {
            background-color: var(--color-bg);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .rule-item__info {
            flex-grow: 1;
        }
        .rule-item__actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        .rule-item__code {
            font-weight: 600;
        }
        .rule-item__checklist {
            list-style-position: inside;
            padding-left: 0.5rem;
            color: var(--color-text-light);
            font-size: 0.9rem;
        }

        .analysis-result {
            background-color: var(--color-bg);
            padding: 1rem;
            max-height: 60vh;
            overflow-y: auto;
        }
        .analysis-result__item {
            padding: 0.5rem 1rem;
            margin-bottom: 0.5rem;
        }
        .analysis-result__item--success {
            background-color: #D1FAE5;
            color: #065F46;
        }
        .analysis-result__item--fail {
            background-color: #FEE2E2;
            color: #991B1B;
        }

        /* Checklist na Tabela */
        .checklist-container {
            position: relative;
            display: inline-block;
        }
        .btn--checklist {
            background-color: var(--color-border);
            color: var(--color-text-light);
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }
        .btn--checklist:hover {
            background-color: var(--color-accent-secondary);
            color: white;
        }
        .checklist-menu {
            display: none;
            position: absolute;
            background-color: var(--color-accent-secondary);
            color: white;
            min-width: 220px;
            z-index: 1;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-0.5rem);
            padding: 0.5rem;
        }
        .checklist-container:hover .checklist-menu {
            display: block;
        }
        .checklist-menu__item {
            display: block;
            padding: 0.5rem;
            cursor: pointer;
        }
        .checklist-menu__item:hover {
            background-color: var(--color-accent-secondary-hover);
        }
        .checklist-menu__checkbox {
            margin-right: 0.5rem;
        }

        /* Romaneio (Impressão) */
        .romaneio-page {
            flex-grow: 1;
            overflow-y: auto;
            background-color: var(--color-panel-bg);
            padding: 2rem;
        }
        .romaneio-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--color-text);
        }
        .romaneio-header p {
            margin-bottom: 0.25rem;
        }
        .romaneio-header strong {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 1rem;
        }
        .romaneio-items {
            display: flex;
            flex-direction: column;
        }
        .romaneio-item {
            padding: 1.5rem 0;
            display: flex;
            gap: 1rem;
            border-bottom: 1px solid var(--color-border);
        }
        .romaneio-items > .romaneio-item:last-child {
            border-bottom: none;
        }
        .romaneio-item__info {
            flex-grow: 1;
        }
        .romaneio-item__pos {
            font-size: 0.9rem;
            color: var(--color-text-light);
            font-weight: 500;
        }
        .romaneio-item__code {
            font-size: 1.2rem;
            font-weight: 700;
        }
        .romaneio-item__desc {
            font-size: 1rem;
            color: var(--color-text-light);
        }
        .romaneio-item__tipo {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--color-danger);
            margin-top: 0.25rem;
        }
        .romaneio-item__image {
            max-width: 70%;
            height: auto;
            margin-top: 1rem;
        }
        .romaneio-item__checklist {
            flex-shrink: 0;
            width: 40%;
            border-left: 1px solid var(--color-border);
            padding-left: 1.5rem;
        }
        .romaneio-item__checklist-title {
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .romaneio-item__checklist-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }
        .romaneio-item__checkbox-group {
            display: flex;
            gap: 0.5rem;
        }
        .romaneio-item__checkbox-box {
            width: 20px;
            height: 20px;
            border: 2px solid var(--color-text-light);
            flex-shrink: 0;
        }
        .romaneio-item__symbol {
            margin-right: 0.5rem;
            font-size: 1.2rem;
            line-height: 1;
        }
        .romaneio-footer {
            padding: 1.5rem 2rem;
            background-color: var(--color-bg);
        }
        .romaneio-observations {
            border-top: 1px solid var(--color-border);
            padding-top: 1.5rem;
            margin-top: 1.5rem;
        }
        .romaneio-signatures {
            padding-top: 4rem;
            margin-top: 4rem;
            display: flex;
            justify-content: space-around;
        }
        .signature-line {
            text-align: center;
        }
        .signature-line > div {
            border-top: 1px solid var(--color-text);
            width: 200px;
            margin-bottom: 0.5rem;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* --- ESTILOS DE IMPRESSÃO CORRIGIDOS --- */
        @media print {
            @page {
                size: A4;
                margin: 1cm; /* Margens reduzidas */
                @top-right {
                    content: "Página " counter(page);
                    font-size: 9pt;
                    color: #888;
                }
            }

            body {
                background-color: #fff !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                counter-reset: page;
            }

            body > *:not(#romaneioModal),
            .modal__close,
            .romaneio-footer {
                display: none !important;
            }

            #romaneioModal,
            #romaneioModal .modal__content,
            .romaneio-page {
                position: static !important;
                display: block !important;
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
                background: transparent !important;
                border: none !important;
                box-shadow: none !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            .romaneio-page {
                font-size: 9pt;
            }

            .romaneio-item {
                page-break-inside: avoid;
                border-bottom: 1px solid #ccc !important;
                height: 13.5cm; /* Altura para caber 2 por página A4 (29.7cm - 2cm margens) */
                display: flex;
                align-items: stretch;
            }
            .romaneio-item__checklist {
                border-left: 1px solid #ccc !important;
            }

            .romaneio-item__image {
                max-width: 49% !important; /* Reduzido em 30% (de 70% para 49%) */
            }
        }
    </style>
</head>
<body>

    <main class="app-container">
        <h1 class="app-header">Leitor de Planilhas com Regras</h1>

        <div class="action-bar">
            <label for="fileInput" class="btn btn--primary">
                <i data-feather="file-plus"></i>
                <span>Selecionar Planilha</span>
            </label>
            <input type="file" id="fileInput" class="file-input" accept=".xlsx, .xls, .csv">

            <button id="configButton" class="btn btn--secondary">
                <i data-feather="settings"></i>
                <span>Configurar Regras</span>
            </button>

            <button id="analyzeTableButton" class="btn btn--warning">
                <i data-feather="bar-chart-2"></i>
                <span>Analisar Tabela</span>
            </button>

            <button id="saveClientButton" class="btn btn--success" style="display: none;">
                <i data-feather="save"></i>
                <span>Salvar Cliente p/ Produção</span>
            </button>

            <button id="viewProductionListButton" class="btn btn--primary" style="display: none;">
                <i data-feather="grid"></i>
                <span>Acessar Dashboard</span>
            </button>

            <button id="romaneioButton" class="btn btn--secondary">
                <i data-feather="file-text"></i>
                <span>Gerar Romaneio</span>
            </button>
            <div class="mode-switch">
                <span id="label-romaneio" class="label-romaneio">Romaneio</span>
                <label class="switch">
                    <input type="checkbox" id="modeToggle">
                    <span class="slider"></span>
                </label>
                <span id="label-producao" class="label-producao">Produção</span>
            </div>
        </div>

        <p id="status" class="status-text">Nenhum arquivo selecionado.</p>

        <div id="spreadsheet-header-container" class="spreadsheet-header">
            <!-- O cabeçalho da planilha será inserido aqui -->
        </div>

        <div id="table-container" class="table-wrapper">
            <!-- A tabela gerada pelo JavaScript será inserida aqui -->
        </div>
    </main>

    <div id="production-dashboard-view" class="production-view">
        <h2 class="production-view__title">Dashboard de Produção</h2>
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th class="data-table__th">Nome do Cliente</th>
                        <th class="data-table__th">Ações</th>
                    </tr>
                </thead>
                <tbody id="production-clients-list">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="production-item-view" class="production-view">
    </div>

    <!-- Modal de Configurações -->
    <div id="configModal" class="modal">
        <div class="modal__content">
            <span class="close-button modal__close">&times;</span>
            <h2 class="modal__title">Gerenciar Regras</h2>

            <!-- Seção para Regras de Código -->
            <div id="rule-form-section" class="modal__section">
                <h3 id="rule-form-title" class="modal__subtitle">Regras de Código</h3>
                <div class="form-grid">
                    <input type="hidden" id="ruleId" value="">
                    <input type="text" id="ruleCode" placeholder="Se o código CONTÉM..." class="form-input">
                    <div id="newChecklistContainer">
                        <!-- Itens do checklist serão inseridos aqui -->
                    </div>
                    <button id="addChecklistItem" class="btn btn--text">+ Adicionar item</button>
                    <button id="saveRule" class="btn btn--success">Salvar Regra de Código</button>
                    <button id="cancelEdit" class="btn btn--secondary" style="display: none;">Cancelar Edição</button>
                </div>
            </div>
            <div class="modal__section">
                <h3 class="modal__subtitle">Regras de Código Salvas</h3>
                <div id="rulesList" class="rules-list"></div>
            </div>

            <!-- Seção para Regras de Peça -->
            <div id="part-rule-form-section" class="modal__section">
                <h3 id="part-rule-form-title" class="modal__subtitle">Regras de Peça</h3>
                <div class="form-grid">
                    <input type="hidden" id="partRuleId" value="">
                    <input type="text" id="partRuleCode" placeholder="Se o código CONTÉM..." class="form-input">
                    <div id="newPartChecklistContainer">
                        <!-- Itens do checklist de peça serão inseridos aqui -->
                    </div>
                    <button id="addPartChecklistItem" class="btn btn--text">+ Adicionar item de peça</button>
                    <button id="savePartRule" class="btn btn--success">Salvar Regra de Peça</button>
                    <button id="cancelPartEdit" class="btn btn--secondary" style="display: none;">Cancelar Edição</button>
                </div>
            </div>
             <div class="modal__section">
                <h3 class="modal__subtitle">Regras de Peça Salvas</h3>
                <div id="partRulesList" class="rules-list"></div>
            </div>

        </div>
    </div>

    <!-- Modal de Análise -->
    <div id="analysisModal" class="modal">
        <div class="modal__content">
            <span class="close-analysis-button modal__close">&times;</span>
            <h2 class="modal__title">Resultado da Análise</h2>
            <div id="analysisResult" class="analysis-result"></div>
        </div>
    </div>

    <!-- Modal de Romaneio -->
    <div id="romaneioModal" class="modal">
        <div class="modal__content modal__content--large">
            <span class="close-romaneio-button modal__close">&times;</span>
            <div id="romaneio-page" class="romaneio-page">
                <div id="romaneio-header"></div>
                <div id="romaneio-items"></div>
            </div>
            <div class="romaneio-footer">
                <button id="printRomaneioButton" class="btn btn--primary">
                    <i data-feather="printer"></i>
                    <span>Imprimir Romaneio</span>
                </button>
            </div>
        </div>
    </div>


    <script>
        // --- O CÓDIGO JAVASCRIPT ABAIXO FOI ATUALIZADO PARA GERENCIAR DOIS TIPOS DE REGRAS ---

        // --- VARIÁVEIS GLOBAIS ---
        let rules = [];
        let partRules = [];
        let codeColumnIndex = -1;
        let fullSpreadsheetData = [];
        let tableHeaderRowIndex = -1;
        let currentMode = 'romaneio'; // Variável de estado
        let rulesRef; // Apenas declarar
        let rulesPartRef; // Apenas declarar

        // --- INICIALIZAÇÃO DO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCB8ye34UIkBghExod4JlBV3oqge5oM2Ic",
            authDomain: "ferramentas-perfecta.firebaseapp.com",
            databaseURL: "https://ferramentas-perfecta-default-rtdb.firebaseio.com",
            projectId: "ferramentas-perfecta",
            storageBucket: "ferramentas-perfecta.appspot.com",
            messagingSenderId: "550722056346",
            appId: "1:550722056346:web:9e2e0948c58e15b5af6f23",
            measurementId: "G-DYF88Y7LY9"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- LÓGICA DOS MODAIS ---
        const configModal = document.getElementById('configModal');
        const analysisModal = document.getElementById('analysisModal');
        const romaneioModal = document.getElementById('romaneioModal');
        const configButton = document.getElementById('configButton');
        const analyzeTableButton = document.getElementById('analyzeTableButton');
        const romaneioButton = document.getElementById('romaneioButton');
        const closeConfigButton = document.querySelector('.close-button');
        const closeAnalysisButton = document.querySelector('.close-analysis-button');
        const closeRomaneioButton = document.querySelector('.close-romaneio-button');
        const printRomaneioButton = document.getElementById('printRomaneioButton');

        configButton.onclick = () => configModal.style.display = 'flex';
        closeConfigButton.onclick = () => {
            configModal.style.display = 'none';
            resetRuleForm();
            resetPartRuleForm();
        };

        analyzeTableButton.onclick = () => {
            analyzeVisibleTable();
            analysisModal.style.display = 'flex';
        };
        closeAnalysisButton.onclick = () => analysisModal.style.display = 'none';

        romaneioButton.onclick = () => {
            generateAndShowRomaneio();
            romaneioModal.style.display = 'flex';
        };
        closeRomaneioButton.onclick = () => romaneioModal.style.display = 'none';
        printRomaneioButton.onclick = () => window.print();

        window.onclick = (event) => {
            if (event.target == configModal) {
                configModal.style.display = 'none';
                resetRuleForm();
                resetPartRuleForm();
            }
            if (event.target == analysisModal) analysisModal.style.display = 'none';
            if (event.target == romaneioModal) romaneioModal.style.display = 'none';
        };

        // Adicione esta nova função após a seção de LÓGICA DOS MODAIS

        function attachFirebaseListeners() {
            // --- SINCRONIZAÇÃO COM FIREBASE (REGRAS DE CÓDIGO) ---
            rulesRef.on('value', (snapshot) => {
                // Todo o conteúdo existente da função rulesRef.on('value', ...) vai aqui
                // (Copie e cole o bloco de código que começa com `const data = snapshot.val();` e termina com a chamada `applyRulesToVisibleTable();`)
                const data = snapshot.val();
                const rulesListEl = document.getElementById('rulesList');
                rulesListEl.innerHTML = '';
                rules = [];

                if (data) {
                    for (const key in data) {
                        rules.push({ id: key, ...data[key] });
                    }
                    rules.sort((a, b) => a.codigo.localeCompare(b.codigo));
                    rules.forEach(rule => {
                        const ruleEl = document.createElement('div');
                        ruleEl.className = 'rule-item';
                        const checklistHTML = rule.checklist.map(item => {
                            if (typeof item === 'string') {
                                return `<li>■ ${item}</li>`;
                            }
                            return `<li>${item.symbol || '■'} ${item.text}</li>`;
                        }).join('');
                        ruleEl.innerHTML = `
                            <div class="rule-item__info">
                                <p class="rule-item__code">Código contém: "${rule.codigo}"</p>
                                <ul class="rule-item__checklist">${checklistHTML}</ul>
                            </div>
                            <div class="rule-item__actions">
                                <button data-id="${rule.id}" class="btn btn--secondary edit-rule-btn">
                                    <i data-feather="edit-2"></i>
                                </button>
                                <button data-id="${rule.id}" class="btn btn--danger delete-rule-btn">
                                    <i data-feather="trash-2"></i>
                                </button>
                            </div>
                        `;
                        rulesListEl.appendChild(ruleEl);
                    });
                } else {
                    rulesListEl.innerHTML = '<p>Nenhuma regra de código cadastrada.</p>';
                }

                document.querySelectorAll('.delete-rule-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        if (confirm('Tem certeza que deseja excluir esta regra?')) {
                            const ruleId = e.currentTarget.getAttribute('data-id');
                            rulesRef.child(ruleId).remove();
                        }
                    });
                });

                document.querySelectorAll('.edit-rule-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const ruleId = e.currentTarget.getAttribute('data-id');
                        const ruleToEdit = rules.find(r => r.id === ruleId);
                        if (ruleToEdit) {
                            document.getElementById('rule-form-title').textContent = 'Editar Regra de Código';
                            document.getElementById('ruleId').value = ruleToEdit.id;
                            document.getElementById('ruleCode').value = ruleToEdit.codigo;
                            newChecklistContainer.innerHTML = '';
                            ruleToEdit.checklist.forEach(item => {
                                const itemData = typeof item === 'string' ? { text: item, symbol: '■' } : item;
                                addChecklistItemInput(itemData, newChecklistContainer, 'code');
                            });
                            cancelEditButton.style.display = 'inline-flex';
                            document.getElementById('rule-form-section').scrollIntoView({ behavior: 'smooth' });
                        }
                    });
                });

                feather.replace();

                if (document.querySelector('#table-container table')) {
                    applyRulesToVisibleTable();
                }
            });

            // --- SINCRONIZAÇÃO COM FIREBASE (REGRAS DE PEÇA) ---
            rulesPartRef.on('value', (snapshot) => {
                // Todo o conteúdo existente da função rulesPartRef.on('value', ...) vai aqui
                // (Copie e cole o bloco de código que começa com `const data = snapshot.val();` e termina com a chamada `applyRulesToVisibleTable();`)
                const data = snapshot.val();
                const partRulesListEl = document.getElementById('partRulesList');
                partRulesListEl.innerHTML = '';
                partRules = [];

                if (data) {
                    for (const key in data) {
                        partRules.push({ id: key, ...data[key] });
                    }
                    partRules.sort((a, b) => a.codigo.localeCompare(b.codigo));
                    partRules.forEach(rule => {
                        const ruleEl = document.createElement('div');
                        ruleEl.className = 'rule-item';
                        const checklistHTML = rule.checklist.map(item => `<li>${item.symbol || '■'} ${item.text} (x${item.quantity})</li>`).join('');
                        ruleEl.innerHTML = `
                            <div class="rule-item__info">
                                <p class="rule-item__code">Código contém: "${rule.codigo}"</p>
                                <ul class="rule-item__checklist">${checklistHTML}</ul>
                            </div>
                            <div class="rule-item__actions">
                                    <button data-id="${rule.id}" class="btn btn--secondary edit-part-rule-btn">
                                    <i data-feather="edit-2"></i>
                                </button>
                                    <button data-id="${rule.id}" class="btn btn--danger delete-part-rule-btn">
                                    <i data-feather="trash-2"></i>
                                </button>
                            </div>
                        `;
                        partRulesListEl.appendChild(ruleEl);
                    });
                } else {
                    partRulesListEl.innerHTML = '<p>Nenhuma regra de peça cadastrada.</p>';
                }

                document.querySelectorAll('.delete-part-rule-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        if (confirm('Tem certeza que deseja excluir esta regra de peça?')) {
                            const ruleId = e.currentTarget.getAttribute('data-id');
                            rulesPartRef.child(ruleId).remove();
                        }
                    });
                });

                document.querySelectorAll('.edit-part-rule-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const ruleId = e.currentTarget.getAttribute('data-id');
                        const ruleToEdit = partRules.find(r => r.id === ruleId);
                        if (ruleToEdit) {
                            document.getElementById('part-rule-form-title').textContent = 'Editar Regra de Peça';
                            document.getElementById('partRuleId').value = ruleToEdit.id;
                            document.getElementById('partRuleCode').value = ruleToEdit.codigo;
                            newPartChecklistContainer.innerHTML = '';
                            ruleToEdit.checklist.forEach(item => addChecklistItemInput(item, newPartChecklistContainer, 'part'));
                            cancelPartEditButton.style.display = 'inline-flex';
                            document.getElementById('part-rule-form-section').scrollIntoView({ behavior: 'smooth' });
                        }
                    });
                });

                feather.replace();

                if (document.querySelector('#table-container table')) {
                    applyRulesToVisibleTable();
                }
            });
        }

        function updateMode() {
            // Desconecta listeners antigos para evitar chamadas duplicadas
            if (rulesRef) rulesRef.off();
            if (rulesPartRef) rulesPartRef.off();

            const isProducao = document.getElementById('modeToggle').checked;
            currentMode = isProducao ? 'producao' : 'romaneio';

            const romaneioBtn = document.getElementById('romaneioButton');
            // NOVAS LINHAS ABAIXO
            const saveClientBtn = document.getElementById('saveClientButton');
            const viewDashboardBtn = document.getElementById('viewProductionListButton');

            if (isProducao) {
                rulesRef = database.ref('dados/producao');
                rulesPartRef = database.ref('dados/producaoPecas');
                romaneioBtn.innerHTML = '<i data-feather="file-text"></i><span>Gerar Produção</span>';
                viewDashboardBtn.style.display = 'inline-flex';
                // O botão de salvar só aparece se uma planilha estiver carregada
                saveClientBtn.style.display = fullSpreadsheetData.length > 0 ? 'inline-flex' : 'none';
            } else {
                rulesRef = database.ref('dados/romaneio');
                rulesPartRef = database.ref('dados/romaneioPecas');
                romaneioBtn.innerHTML = '<i data-feather="file-text"></i><span>Gerar Romaneio</span>';
                viewDashboardBtn.style.display = 'none';
                saveClientBtn.style.display = 'none';
            }

            // Reconecta os listeners para os novos caminhos do Firebase
            attachFirebaseListeners();
            // Atualiza os ícones que foram recriados
            feather.replace();
        }

        // --- LÓGICA DE GERENCIAMENTO DE REGRAS (GERAL) ---
        const addChecklistItemInput = (itemData, container, type = 'code') => {
            const wrapper = document.createElement('div');
            wrapper.className = 'checklist-item-wrapper';
            wrapper.draggable = true;

            const handle = document.createElement('span');
            handle.className = 'drag-handle';
            handle.innerHTML = '<i data-feather="move" style="width:20px; height:20px; cursor: grab;"></i>';

            const symbolSelect = document.createElement('select');
            symbolSelect.className = 'form-select checklist-item-symbol';
            symbolSelect.style.width = '60px';
            symbolSelect.innerHTML = `
                <option value="■">■</option>
                <option value="▲">▲</option>
                <option value="●">●</option>
                <option value="*">*</option>
            `;
            symbolSelect.value = itemData.symbol || '■';

            const newInput = document.createElement('input');
            newInput.type = 'text';
            newInput.placeholder = 'Item do checklist';
            newInput.className = 'new-checklist-item form-input';
            newInput.value = itemData.text || '';

            wrapper.appendChild(handle);
            wrapper.appendChild(symbolSelect);
            wrapper.appendChild(newInput);

            if (type === 'part') {
                const quantityInput = document.createElement('input');
                quantityInput.type = 'number';
                quantityInput.className = 'checklist-item-quantity form-input';
                quantityInput.value = itemData.quantity || 1;
                quantityInput.min = 1;
                quantityInput.style.width = '80px';
                quantityInput.title = 'Quantidade de caixas de seleção';
                wrapper.appendChild(quantityInput);
            }

            const deleteButton = document.createElement('button');
            deleteButton.className = 'btn--icon';
            deleteButton.innerHTML = '<i data-feather="x-circle" style="width:20px; height:20px;"></i>';
            deleteButton.onclick = () => {
                wrapper.remove();
                feather.replace();
            };

            wrapper.appendChild(deleteButton);
            container.appendChild(wrapper);

            wrapper.addEventListener('dragstart', () => wrapper.classList.add('dragging'));
            wrapper.addEventListener('dragend', () => wrapper.classList.remove('dragging'));

            feather.replace();
        };

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.checklist-item-wrapper:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // --- LÓGICA DE GERENCIAMENTO DE REGRAS DE CÓDIGO ---
        const addChecklistItemButton = document.getElementById('addChecklistItem');
        const newChecklistContainer = document.getElementById('newChecklistContainer');
        const saveRuleButton = document.getElementById('saveRule');
        const cancelEditButton = document.getElementById('cancelEdit');

        addChecklistItemButton.addEventListener('click', () => addChecklistItemInput({text: '', symbol: '■'}, newChecklistContainer, 'code'));

        newChecklistContainer.addEventListener('dragover', e => {
            e.preventDefault();
            const afterElement = getDragAfterElement(newChecklistContainer, e.clientY);
            const dragging = document.querySelector('.dragging');
            if (dragging && dragging.parentElement === newChecklistContainer) {
                if (afterElement == null) {
                    newChecklistContainer.appendChild(dragging);
                } else {
                    newChecklistContainer.insertBefore(dragging, afterElement);
                }
            }
        });

        const resetRuleForm = () => {
            document.getElementById('rule-form-title').textContent = 'Regras de Código';
            document.getElementById('ruleId').value = '';
            document.getElementById('ruleCode').value = '';
            newChecklistContainer.innerHTML = '';
            addChecklistItemInput({text: '', symbol: '■'}, newChecklistContainer, 'code');
            cancelEditButton.style.display = 'none';
        };

        cancelEditButton.addEventListener('click', resetRuleForm);

        saveRuleButton.addEventListener('click', () => {
            const ruleId = document.getElementById('ruleId').value;
            const code = document.getElementById('ruleCode').value.trim();
            if (!code) {
                alert('Por favor, insira o código da regra.');
                return;
            }
            const checklistItems = Array.from(document.querySelectorAll('#newChecklistContainer .checklist-item-wrapper'))
                .map(wrapper => ({
                    text: wrapper.querySelector('.new-checklist-item').value.trim(),
                    symbol: wrapper.querySelector('.checklist-item-symbol').value
                }))
                .filter(item => item.text !== '');

            if (checklistItems.length === 0) {
                alert('Adicione pelo menos um item ao checklist.');
                return;
            }

            const ruleData = { codigo: code, checklist: checklistItems };

            if (ruleId) {
                rulesRef.child(ruleId).update(ruleData);
            } else {
                rulesRef.push(ruleData);
            }

            resetRuleForm();
        });

        // --- LÓGICA DE GERENCIAMENTO DE REGRAS DE PEÇA ---
        const addPartChecklistItemButton = document.getElementById('addPartChecklistItem');
        const newPartChecklistContainer = document.getElementById('newPartChecklistContainer');
        const savePartRuleButton = document.getElementById('savePartRule');
        const cancelPartEditButton = document.getElementById('cancelPartEdit');

        addPartChecklistItemButton.addEventListener('click', () => addChecklistItemInput({ text: '', quantity: 1, symbol: '■' }, newPartChecklistContainer, 'part'));

        newPartChecklistContainer.addEventListener('dragover', e => {
            e.preventDefault();
            const afterElement = getDragAfterElement(newPartChecklistContainer, e.clientY);
            const dragging = document.querySelector('.dragging');
             if (dragging && dragging.parentElement === newPartChecklistContainer) {
                if (afterElement == null) {
                    newPartChecklistContainer.appendChild(dragging);
                } else {
                    newPartChecklistContainer.insertBefore(dragging, afterElement);
                }
            }
        });

        const resetPartRuleForm = () => {
            document.getElementById('part-rule-form-title').textContent = 'Regras de Peça';
            document.getElementById('partRuleId').value = '';
            document.getElementById('partRuleCode').value = '';
            newPartChecklistContainer.innerHTML = '';
            addChecklistItemInput({ text: '', quantity: 1, symbol: '■' }, newPartChecklistContainer, 'part');
            cancelPartEditButton.style.display = 'none';
        };

        cancelPartEditButton.addEventListener('click', resetPartRuleForm);

        savePartRuleButton.addEventListener('click', () => {
            const ruleId = document.getElementById('partRuleId').value;
            const code = document.getElementById('partRuleCode').value.trim();
            if (!code) {
                alert('Por favor, insira o código da peça.');
                return;
            }
            const checklistItems = Array.from(document.querySelectorAll('#newPartChecklistContainer .checklist-item-wrapper'))
                .map(wrapper => ({
                    text: wrapper.querySelector('.new-checklist-item').value.trim(),
                    quantity: parseInt(wrapper.querySelector('.checklist-item-quantity').value, 10) || 1,
                    symbol: wrapper.querySelector('.checklist-item-symbol').value
                }))
                .filter(item => item.text !== '');

            if (checklistItems.length === 0) {
                alert('Adicione pelo menos um item ao checklist da peça.');
                return;
            }

            const ruleData = { codigo: code, checklist: checklistItems };
            if (ruleId) {
                rulesPartRef.child(ruleId).update(ruleData);
            } else {
                rulesPartRef.push(ruleData);
            }
            resetPartRuleForm();
        });


        // --- FUNÇÃO 1: DESENHA A TABELA SEM AS REGRAS ---
        function drawInitialTable(jsonData) {
            const tableContainer = document.getElementById('table-container');
            const spreadsheetHeaderContainer = document.getElementById('spreadsheet-header-container');
            const statusEl = document.getElementById('status');

            tableContainer.innerHTML = '';
            spreadsheetHeaderContainer.innerHTML = '';
            codeColumnIndex = -1;
            tableHeaderRowIndex = -1;

            let header = [];

            for (let i = 0; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (row && Array.isArray(row)) {
                    const foundIndex = row.findIndex(cell => typeof cell === 'string' && cell.toUpperCase().includes('CÓDIGO'));
                    if (foundIndex !== -1) {
                        tableHeaderRowIndex = i;
                        codeColumnIndex = foundIndex;
                        header = [...jsonData[tableHeaderRowIndex]];
                        break;
                    }
                }
            }

            if (tableHeaderRowIndex > 0) {
                const spreadsheetHeaderData = jsonData.slice(0, tableHeaderRowIndex);
                const headerContent = document.createElement('div');
                headerContent.className = 'spreadsheet-header__content';
                spreadsheetHeaderData.forEach(row => {
                    const rowString = row.join('').toUpperCase();
                    if (rowString.includes('OBRA:') || rowString.includes('PREVISÃO DE ENTREGA:') || rowString.includes('VENDEDOR:')) {
                        return;
                    }

                    const filteredCells = row.filter(cell => cell !== null && String(cell).trim() !== '');
                    if (filteredCells.length > 0) {
                        const p = document.createElement('p');
                        p.className = 'spreadsheet-header__line';

                        if (String(filteredCells[0]).toLowerCase().includes('planilha de itens')) {
                            p.innerHTML = `<strong>${filteredCells.join(' ')}</strong>`;
                            p.classList.add('spreadsheet-header__line--title');
                        } else {
                            p.textContent = filteredCells.join(' \u00A0\u00A0\u00A0 ');
                        }
                        headerContent.appendChild(p);
                    }
                });
                spreadsheetHeaderContainer.appendChild(headerContent);
            }

            if (codeColumnIndex === -1) {
                statusEl.textContent = 'Aviso: A coluna "Código" não foi encontrada.';
            }

            if (!header.some(h => typeof h === 'string' && h.toUpperCase() === 'CHECKLIST')) {
                 header.push('Checklist');
            }

            const tableData = jsonData.slice(tableHeaderRowIndex !== -1 ? tableHeaderRowIndex + 1 : 0);
            const table = document.createElement('table');
            table.className = "data-table";
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');

            const headerRow = document.createElement('tr');
            header.forEach(headerText => {
                const th = document.createElement('th');
                th.className = "data-table__th";
                th.textContent = headerText || '';
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            tableData.forEach((rowData) => {
                if (!rowData || rowData.every(cell => cell === null || cell === '')) return;
                const dataRow = document.createElement('tr');
                rowData.forEach(cellText => {
                    const td = document.createElement('td');
                    td.className = "data-table__td";
                    td.textContent = cellText || '';
                    dataRow.appendChild(td);
                });
                dataRow.insertCell(-1).className = "data-table__td";
                tbody.appendChild(dataRow);
            });

            table.appendChild(thead);
            table.appendChild(tbody);

            const tfoot = document.createElement('tfoot');
            tfoot.className = 'data-table__tfoot';
            const footerRow = document.createElement('tr');
            const footerCell = document.createElement('td');
            footerCell.colSpan = header.length;
            footerCell.style.padding = '1rem';

            const footerContent = `
                <label for="observation-notes" style="display:block; font-weight:600; margin-bottom:0.5rem;">Observações:</label>
                <textarea id="observation-notes" rows="4" class="form-textarea"></textarea>
            `;
            footerCell.innerHTML = footerContent;
            footerRow.appendChild(footerCell);
            tfoot.appendChild(footerRow);
            table.appendChild(tfoot);

            tableContainer.appendChild(table);
        }

        // --- FUNÇÃO 2: APLICA AS REGRAS NA TABELA QUE JÁ ESTÁ NA TELA ---
        function applyRulesToVisibleTable() {
            if (codeColumnIndex === -1) return;

            const table = document.querySelector('#table-container table');
            if (!table) return;

            const dataRows = Array.from(table.querySelectorAll('tbody tr'));

            dataRows.forEach((row) => {
                const codeCell = row.cells[codeColumnIndex];
                const checklistCell = row.cells[row.cells.length - 1];
                if (!codeCell || !checklistCell) return;

                const itemCode = (codeCell.textContent || '').trim().toUpperCase();
                checklistCell.innerHTML = '';

                let combinedChecklist = [];

                const applicablePartRules = partRules.filter(rule => {
                    const ruleCode = (rule.codigo || '').toUpperCase();
                    return ruleCode && itemCode.includes(ruleCode);
                });
                if(applicablePartRules.length > 0) {
                    applicablePartRules.forEach(rule => {
                        rule.checklist.forEach(item => combinedChecklist.push(item.text));
                    });
                }

                const applicableRules = rules.filter(rule => {
                    const ruleCode = (rule.codigo || '').toUpperCase();
                    return ruleCode && itemCode.includes(ruleCode);
                });
                if(applicableRules.length > 0) {
                    applicableRules.forEach(rule => {
                        rule.checklist.forEach(item => {
                            const text = (typeof item === 'string') ? item : item.text;
                            combinedChecklist.push(text);
                        });
                    });
                }

                if (combinedChecklist.length > 0) {
                    const container = document.createElement('div');
                    container.className = 'checklist-container';
                    const button = document.createElement('button');
                    button.textContent = 'Checklist';
                    button.className = 'btn btn--checklist';
                    const menu = document.createElement('div');
                    menu.className = 'checklist-menu';
                    combinedChecklist.forEach(item => {
                        menu.innerHTML += `<label class="checklist-menu__item"><input type="checkbox" class="checklist-menu__checkbox">${item}</label>`;
                    });
                    container.appendChild(button);
                    container.appendChild(menu);
                    checklistCell.appendChild(container);
                }
            });
        }

        // --- FUNÇÃO 3: ANALISA A TABELA VISÍVEL E MOSTRA O RESULTADO ---
        function analyzeVisibleTable() {
            const analysisResultContainer = document.getElementById('analysisResult');
            analysisResultContainer.innerHTML = '';

            const table = document.querySelector('#table-container table');
            if (!table) {
                analysisResultContainer.innerHTML = '<p class="analysis-result__item analysis-result__item--fail">Nenhuma tabela para analisar.</p>';
                return;
            }
            if (codeColumnIndex === -1) {
                analysisResultContainer.innerHTML = '<p class="analysis-result__item analysis-result__item--fail">Não foi possível identificar a coluna de código.</p>';
                return;
            }

            const dataRows = Array.from(table.querySelectorAll('tbody tr'));
            if (dataRows.length === 0) {
                analysisResultContainer.innerHTML = '<p>A tabela não contém dados para analisar.</p>';
                return;
            }

            dataRows.forEach((row, rowIndex) => {
                const codeCell = row.cells[codeColumnIndex];
                const checklistCell = row.cells[row.cells.length - 1];
                const hasChecklist = checklistCell && checklistCell.querySelector('.checklist-container');
                const itemCode = codeCell ? codeCell.textContent : 'N/A';

                const resultEl = document.createElement('p');
                resultEl.className = 'analysis-result__item';

                if (hasChecklist) {
                    resultEl.textContent = `Linha ${rowIndex + 1} (Código: ${itemCode}): TEM CHECKLIST`;
                    resultEl.classList.add('analysis-result__item--success');
                } else {
                    resultEl.textContent = `Linha ${rowIndex + 1} (Código: ${itemCode}): NÃO TEM CHECKLIST`;
                     resultEl.classList.add('analysis-result__item--fail');
                }
                analysisResultContainer.appendChild(resultEl);
            });
        }

        // --- FUNÇÃO 4: GERA E MOSTRA O ROMANEIO ---
        function generateAndShowRomaneio() {
            const romaneioHeaderContainer = document.getElementById('romaneio-header');
            const romaneioItemsContainer = document.getElementById('romaneio-items');
            romaneioHeaderContainer.innerHTML = '';
            romaneioItemsContainer.innerHTML = '';

            if (fullSpreadsheetData.length === 0 || tableHeaderRowIndex === -1) {
                romaneioItemsContainer.innerHTML = '<p>Carregue uma planilha primeiro.</p>';
                return;
            }

            const spreadsheetHeaderData = fullSpreadsheetData.slice(0, tableHeaderRowIndex);
            spreadsheetHeaderData.forEach(row => {
                const rowString = row.join('').toUpperCase();
                if (rowString.includes('OBRA:') || rowString.includes('PREVISÃO DE ENTREGA:') || rowString.includes('VENDEDOR:')) {
                    return;
                }

                const filteredCells = row.filter(cell => cell !== null && String(cell).trim() !== '');
                if (filteredCells.length > 0) {
                    const p = document.createElement('p');
                    if (String(filteredCells[0]).toLowerCase().includes('planilha de itens')) {
                        // LINHA MODIFICADA ABAIXO
                        const title = currentMode === 'producao' ? 'Relatório de Produção' : 'Romaneio de Conferência';
                        p.innerHTML = `<strong>${title}</strong>`;
                    } else {
                         p.innerHTML = filteredCells.map(cell => `<span>${cell}</span>`).join('<span style="margin: 0 1rem;">|</span>');
                    }
                    romaneioHeaderContainer.appendChild(p);
                }
            });

            const tableData = fullSpreadsheetData.slice(tableHeaderRowIndex + 1);
            const tableHeader = fullSpreadsheetData[tableHeaderRowIndex];
            const descColumnIndex = tableHeader.findIndex(h => String(h).toUpperCase().includes('DESCRIÇÃO'));
            const tipoColumnIndex = tableHeader.findIndex(h => String(h).toUpperCase() === 'TIPO');

            tableData.forEach((rowData, index) => {
                const itemCode = String(rowData[codeColumnIndex] || '').trim().toUpperCase();
                if (!itemCode) return;

                const itemDesc = descColumnIndex !== -1 ? String(rowData[descColumnIndex] || '') : 'Sem descrição';
                const itemTipo = tipoColumnIndex !== -1 ? String(rowData[tipoColumnIndex] || '') : '';
                const itemPos = String(rowData[0] || index + 1);

                let combinedChecklist = [];

                const applicablePartRules = partRules.filter(rule => itemCode.includes((rule.codigo || '').toUpperCase()));
                if(applicablePartRules.length > 0) {
                    applicablePartRules.forEach(rule => {
                        rule.checklist.forEach(item => combinedChecklist.push({ text: item.text, quantity: item.quantity, symbol: item.symbol }));
                    });
                }

                const applicableRules = rules.filter(rule => itemCode.includes((rule.codigo || '').toUpperCase()));
                if(applicableRules.length > 0) {
                    applicableRules.forEach(rule => {
                        rule.checklist.forEach(item => {
                            if (typeof item === 'string') {
                                combinedChecklist.push({ text: item, quantity: 1, symbol: '■' });
                            } else {
                                combinedChecklist.push({ text: item.text, quantity: 1, symbol: item.symbol });
                            }
                        });
                    });
                }

                const itemCard = document.createElement('div');
                itemCard.className = 'romaneio-item';

                let checklistHTML = `<h4 class="romaneio-item__checklist-title">Checklist de Conferência</h4>`;
                if (combinedChecklist.length > 0) {
                    combinedChecklist.forEach(checkItem => {
                        let boxesHTML = '';
                        for (let i = 0; i < checkItem.quantity; i++) {
                            boxesHTML += '<div class="romaneio-item__checkbox-box"></div>';
                        }
                        checklistHTML += `
                            <div class="romaneio-item__checklist-item">
                                <div>
                                    <span class="romaneio-item__symbol">${checkItem.symbol || '■'}</span>
                                    <span>${checkItem.text}</span>
                                </div>
                                <div class="romaneio-item__checkbox-group">${boxesHTML}</div>
                            </div>
                        `;
                    });
                } else {
                    checklistHTML += '<p style="font-size: 0.9rem; color: var(--color-text-light);">Nenhum checklist para este item.</p>';
                }

                const imageMapping = {
                    PCR: 'pcr.png', JCR: 'jcr.png', PGR: 'pgr.png',
                    FIX: 'fix.png', ABT: 'abt.png', IPC: 'ipc.png',
                    IJC: 'ijc.png', PIV: 'piv.png', MAX: 'max.png'
                };
                let imageHTML = '';
                for (const key in imageMapping) {
                    if (itemCode.includes(key)) {
                        imageHTML = `<img src="${imageMapping[key]}" class="romaneio-item__image" alt="Imagem ${key}">`;
                        break;
                    }
                }

                itemCard.innerHTML = `
                    <div class="romaneio-item__info">
                        <p class="romaneio-item__pos">Pos. ${itemPos}</p>
                        <p class="romaneio-item__code">${itemCode}</p>
                        <p class="romaneio-item__desc">${itemDesc}</p>
                        ${itemTipo ? `<p class="romaneio-item__tipo">${itemTipo}</p>` : ''}
                        ${imageHTML}
                    </div>
                    <div class="romaneio-item__checklist">${checklistHTML}</div>
                `;
                romaneioItemsContainer.appendChild(itemCard);
            });

            const observationNotes = document.getElementById('observation-notes');
            if (observationNotes && observationNotes.value.trim() !== '') {
                const observationSection = document.createElement('div');
                observationSection.className = 'romaneio-observations';
                observationSection.innerHTML = `
                    <h4 class="romaneio-item__checklist-title">Observações</h4>
                    <p style="white-space: pre-wrap;">${observationNotes.value}</p>
                `;
                romaneioItemsContainer.appendChild(observationSection);
            }

            const signatureSection = document.createElement('div');
            signatureSection.className = 'romaneio-signatures';
            signatureSection.innerHTML = `
                <div class="signature-line">
                    <div></div>
                    <p>Assinatura Conferente</p>
                </div>
                <div class="signature-line">
                    <div></div>
                    <p>Assinatura do Supervisor</p>
                </div>
            `;
            romaneioItemsContainer.appendChild(signatureSection);
        }

        // --- NOVAS FUNÇÕES DE PRODUÇÃO ---

        function saveClientForProduction() {
            if (fullSpreadsheetData.length === 0) {
                alert('Nenhuma planilha carregada para salvar.');
                return;
            }

            // Pega o nome do cliente do cabeçalho da planilha
            const headerTitleEl = document.querySelector('.spreadsheet-header__line--title strong');
            if (!headerTitleEl) {
                alert('Não foi possível identificar o nome do cliente no cabeçalho.');
                return;
            }
            const clientName = headerTitleEl.textContent.replace('Planilha de Itens ', '').trim();

            const clientData = {
                name: clientName,
                spreadsheetData: fullSpreadsheetData,
                createdAt: new Date().toISOString()
            };

            const productionClientsRef = database.ref('dados/producao_clientes');
            productionClientsRef.push(clientData)
                .then(() => {
                    alert(`Cliente "${clientName}" salvo para produção com sucesso!`);
                })
                .catch(error => {
                    console.error("Erro ao salvar cliente:", error);
                    alert("Ocorreu um erro ao salvar o cliente.");
                });
        }

        function showProductionDashboard() {
            document.querySelector('.app-container').style.display = 'none';
            const dashboardView = document.getElementById('production-dashboard-view');
            dashboardView.style.display = 'block';

            const listBody = document.getElementById('production-clients-list');
            listBody.innerHTML = '<tr><td colspan="2">Carregando...</td></tr>';

            const productionClientsRef = database.ref('dados/producao_clientes');
            productionClientsRef.once('value', snapshot => {
                listBody.innerHTML = '';
                const clients = snapshot.val();
                if (clients) {
                    Object.keys(clients).forEach(clientId => {
                        const client = clients[clientId];
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="data-table__td">${client.name}</td>
                            <td class="data-table__td">
                                <button class="btn btn--primary" onclick="showProductionItemView('${clientId}')">Ver Ordem</button>
                            </td>
                        `;
                        listBody.appendChild(row);
                    });
                } else {
                    listBody.innerHTML = '<tr><td colspan="2">Nenhum cliente em produção.</td></tr>';
                }
            });
        }

        function showProductionItemView(clientId) {
            document.getElementById('production-dashboard-view').style.display = 'none';
            const itemView = document.getElementById('production-item-view');
            itemView.style.display = 'block';
            itemView.innerHTML = '<h2>Carregando dados da ordem...</h2>';

            const clientRef = database.ref(`dados/producao_clientes/${clientId}`);
            clientRef.once('value', snapshot => {
                const clientData = snapshot.val();
                if (!clientData) {
                    itemView.innerHTML = '<h2>Erro: Cliente não encontrado.</h2>';
                    return;
                }

                // Reutiliza a lógica de `generateAndShowRomaneio` para renderizar a base
                const localTableHeaderRowIndex = clientData.spreadsheetData.findIndex(row => row.some(cell => String(cell).toUpperCase().includes('CÓDIGO')));
                const localCodeColumnIndex = clientData.spreadsheetData[localTableHeaderRowIndex].findIndex(cell => String(cell).toUpperCase().includes('CÓDIGO'));
                const tableHeader = clientData.spreadsheetData[localTableHeaderRowIndex];
                const descColumnIndex = tableHeader.findIndex(h => String(h).toUpperCase().includes('DESCRIÇÃO'));

                let contentHTML = `<h2 class="production-view__title">Acompanhamento: ${clientData.name}</h2>`;

                const tableData = clientData.spreadsheetData.slice(localTableHeaderRowIndex + 1);
                tableData.forEach((rowData, index) => {
                    const itemCode = String(rowData[localCodeColumnIndex] || '').trim().toUpperCase();
                    if (!itemCode) return;

                    const itemPos = String(rowData[0] || index + 1);
                    const itemDesc = descColumnIndex !== -1 ? String(rowData[descColumnIndex] || '') : 'Sem descrição';

                    let combinedChecklist = [];
                    partRules.filter(r => itemCode.includes((r.codigo || '').toUpperCase())).forEach(r => r.checklist.forEach(i => combinedChecklist.push(i)));
                    rules.filter(r => itemCode.includes((r.codigo || '').toUpperCase())).forEach(r => r.checklist.forEach(i => combinedChecklist.push(typeof i === 'string' ? {text: i} : i)));

                    let checklistHTML = `<h4 class="romaneio-item__checklist-title">Checklist Interativo</h4>`;
                    if(combinedChecklist.length > 0) {
                        combinedChecklist.forEach((checkItem, checkIndex) => {
                            const checkId = `check-${clientId}-${itemPos}-${checkIndex}`;
                            checklistHTML += `
                                <div class="interactive-checklist-item">
                                    <label for="${checkId}">
                                        <input type="checkbox" id="${checkId}" onchange="updateChecklistStatus('${clientId}', '${itemPos}', '${checkItem.text.replace(/'/g, "\\'")}', this.checked)">
                                        <span class="romaneio-item__symbol">${checkItem.symbol || '■'}</span>
                                        <span>${checkItem.text}</span>
                                    </label>
                                </div>
                            `;
                        });
                    } else {
                        checklistHTML += '<p>Nenhum checklist para este item.</p>';
                    }

                    contentHTML += `
                        <div class="romaneio-item" style="border-bottom: 2px solid #ccc; align-items: flex-start;">
                            <div class="romaneio-item__info">
                                <p class="romaneio-item__pos">Pos. ${itemPos}</p>
                                <p class="romaneio-item__code">${itemCode}</p>
                                <p class="romaneio-item__desc">${itemDesc}</p>
                            </div>
                            <div class="romaneio-item__checklist">${checklistHTML}</div>
                        </div>
                    `;

                    // Após renderizar o HTML, busca os estados salvos
                    const statusRef = database.ref(`dados/producao_checklist_status/${clientId}/${itemPos}`);
                    statusRef.on('value', statusSnapshot => {
                        const statuses = statusSnapshot.val();
                        if (statuses) {
                            combinedChecklist.forEach((checkItem, checkIndex) => {
                                const checkId = `check-${clientId}-${itemPos}-${checkIndex}`;
                                const checkbox = document.getElementById(checkId);
                                if (checkbox) {
                                    checkbox.checked = statuses[checkItem.text] === true;
                                }
                            });
                        }
                    });
                });

                itemView.innerHTML = contentHTML;
            });
        }

        function updateChecklistStatus(clientId, itemPos, itemText, isChecked) {
            const statusRef = database.ref(`dados/producao_checklist_status/${clientId}/${itemPos}`);
            statusRef.update({
                [itemText]: isChecked
            });
        }

        // --- LEITURA DO ARQUIVO ---
        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            const statusEl = document.getElementById('status');

            if (!file) {
                statusEl.textContent = 'Nenhum arquivo selecionado.';
                document.getElementById('table-container').innerHTML = '';
                document.getElementById('spreadsheet-header-container').innerHTML = '';
                fullSpreadsheetData = [];
                return;
            }
            statusEl.textContent = `Processando "${file.name}"...`;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    fullSpreadsheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });

                    drawInitialTable(fullSpreadsheetData);
                    applyRulesToVisibleTable();

                    statusEl.textContent = `Exibindo dados de "${file.name}".`;
                    if (currentMode === 'producao') {
                        document.getElementById('saveClientButton').style.display = 'inline-flex';
                    }
                } catch (error) {
                    console.error("Erro ao processar o arquivo:", error);
                    statusEl.textContent = 'Ocorreu um erro ao ler o arquivo.';
                }
            };
            reader.readAsBinaryString(file);
        });

        // --- INICIALIZA O SISTEMA ---
        document.getElementById('modeToggle').addEventListener('change', updateMode);
        // NOVOS LISTENERS
        document.getElementById('saveClientButton').addEventListener('click', saveClientForProduction);
        document.getElementById('viewProductionListButton').addEventListener('click', showProductionDashboard);

        // Configuração inicial ao carregar a página
        updateMode();
        resetRuleForm();
        resetPartRuleForm();
        feather.replace(); // Garante que todos os ícones sejam renderizados
    </script>
</body>
</html>
